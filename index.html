<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GPSpedia | Catálogo Técnico</title>
    <link rel="icon" href="https://drive.google.com/thumbnail?id=1NxBx-W_gWmcq3fA9zog6Dpe-WXpH_2e8&sz=w256">
    <link rel="manifest" href="manifest.json">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --primary-color: #007bff; --dark-primary: #0056b3; --secondary-color: #333; --background-color: #f4f4f4; --card-background: #fff; --text-color: #333; --light-text: #fff; --error-color: #dc3545; }
        html { height: 100%; }
        body { font-family: Arial, sans-serif; margin: 0; background-color: var(--background-color); display: flex; flex-direction: column; min-height: 100%; color: var(--text-color); }
        h1,h2,h3,h4 { margin: 10px 0; }
        .container { padding: 20px; max-width: 1240px; margin: 0 auto; width: 100%; box-sizing: border-box; flex: 1 0 auto; }
        .header-container { display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; margin-bottom: 20px; gap: 15px; }
        .header-branding { display: flex; align-items: center; gap: 15px; }
        .app-logo { max-width: 96px; height: auto; border-radius: 8px; }
        h1.app-title { margin: 0; font-size: 2.2em; color: var(--secondary-color); }
        .search-and-menu-container { display: flex; align-items: center; gap: 15px; margin-bottom: 30px; max-width: 600px; margin-left: auto; margin-right: auto; }
        .search-container { position: relative; flex-grow: 1; }
        .search-container input[type="text"] { width: 100%; padding: 12px 15px; border: 1px solid #ccc; border-radius: 8px; box-sizing: border-box; font-size: 1em; }
        #clear-search-btn { position: absolute; right: 15px; top: 50%; transform: translateY(-50%); background: #ccc; color: var(--light-text); border: none; border-radius: 50%; width: 24px; height: 24px; font-size: 16px; line-height: 24px; text-align: center; cursor: pointer; opacity: 0; pointer-events: none; }
        .search-container.has-text #clear-search-btn { opacity: 1; pointer-events: all; }
        #hamburger-btn { background: none; border: none; font-size: 24px; cursor: pointer; color: var(--secondary-color); padding: 10px; border-radius: 8px; }
        #side-menu { position: fixed; top: 0; right: -300px; width: 280px; height: 100%; background-color: var(--card-background); box-shadow: -2px 0 10px rgba(0,0,0,0.1); z-index: 2500; transition: right 0.3s ease-in-out; display: flex; flex-direction: column; }
        #side-menu.open { right: 0; }
        #menu-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2400; }
        #menu-overlay.open { display: block; }
        #side-menu nav a { display: flex; align-items: center; gap: 15px; padding: 15px 20px; text-decoration: none; color: var(--text-color); }
        .grid { display: grid; gap: 20px; grid-template-columns: repeat(auto-fit, 140px); justify-content: center; max-width: 1200px; margin: 0 auto; }
        .card { position: relative; background: var(--card-background); border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); cursor: pointer; overflow: hidden; }
        .card img { width: 100%; height: 120px; object-fit: contain; display: block; }
        .overlay { position: absolute; bottom: 0; left: 0; right: 0; background: linear-gradient(to top, rgba(0,0,0,0.9) 0%, rgba(0,0,0,0) 100%); color: var(--light-text); padding: 10px 8px; font-size: 0.9em; font-weight: bold; }
        .skeleton-grid { display: grid; gap: 20px; grid-template-columns: repeat(auto-fit, 140px); justify-content: center; max-width: 1200px; margin: 0 auto; }
        .skeleton-card { background: #e0e0e0; border-radius: 12px; width: 140px; height: 188px; position: relative; overflow: hidden; }
        #login-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 3000; }
        .modal-content { background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); padding: 40px; border-radius: 15px; width: 100%; max-width: 400px; text-align: center; color: #f0f0f0; }
        #custom-alert-modal { display: none; position: fixed; z-index: 4000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); }
        .custom-alert-content { background: var(--card-background); margin: 15% auto; padding: 20px; border-radius: 10px; width: 80%; max-width: 400px; text-align: center; }
        #splash-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #f4f4f4; display: flex; align-items: center; justify-content: center; z-index: 5000; }
        #modalDetalle { display: none; position: fixed; z-index: 1600; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); }
        #detalleCompleto { background: var(--card-background); margin: 5% auto; padding: 30px; border-radius: 15px; width: 90%; max-width: 800px; max-height: 90vh; overflow-y: auto; }
        .footer { text-align: center; padding: 20px 0; margin-top: 40px; background-color: var(--secondary-color); color: var(--light-text); }
    </style>
</head>
<body>
    <div id="splash-screen"><img src="https://drive.google.com/thumbnail?id=1NxBx-W_gWmcq3fA9zog6Dpe-WXpH_2e8&sz=w512" alt="Logo"></div>
    <div id="login-modal" style="display: none;"><div class="modal-content">
        <h2>Iniciar Sesión</h2>
        <form id="login-form">
            <input type="text" id="username" placeholder="Usuario" required><br><br>
            <input type="password" id="password" placeholder="Contraseña" required><br><br>
            <button type="submit">Acceder</button>
        </form>
    </div></div>
    <div id="custom-alert-modal"><div class="custom-alert-content">
        <p id="custom-alert-message"></p>
        <button id="custom-alert-close-btn">Entendido</button>
    </div></div>
    <div id="menu-overlay"></div>
    <div id="side-menu"><!-- Menu structure --></div>
    <div class="container" style="display: none;">
        <div class="header-container">
            <div class="header-branding">
                <img src="https://drive.google.com/thumbnail?id=1NxBx-W_gWmcq3fA9zog6Dpe-WXpH_2e8&sz=2048" alt="Logo" class="app-logo">
                <h1 class="app-title">GPSpedia</h1>
            </div>
            <span id="welcome-message"></span>
        </div>
        <div class="search-and-menu-container">
            <div class="search-container">
                <input type="text" id="searchInput" placeholder="Buscar Corte...">
                <button id="clear-search-btn">&times;</button>
            </div>
            <button id="hamburger-btn"><i class="fa-solid fa-bars"></i></button>
        </div>
        <div id="contenido" class="content-section"></div>
    </div>
    <div id="modalDetalle"><div id="detalleCompleto"></div></div>
    <footer class="footer" style="display: none;">GPSpedia 2025©</footer>

<script>
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbx1WubkKI7Jr0RG0qfaITAlrFOBzPJ-qIES-1njU-IS7UTVx4CdUw2WErfKlFE38nEz/exec";
const SESSION_KEY = 'gpsepedia_session';
let datosOriginales = [], datosFiltrados = [], datosTutoriales = [], datosRelay = [];
let estado = { nivel: "categorias", categoria: null, marca: null, modelo: null };

async function postToAction(action, payload = {}) {
    try {
        const response = await fetch(SCRIPT_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ action, payload })
        });
        if (!response.ok) throw new Error(`Error de red: ${response.statusText}`);
        const result = await response.json();
        if (result.status === 'error') throw new Error(result.details || result.message);
        return result;
    } catch (error) {
        console.error(`Error en '${action}':`, error);
        showCustomAlert(error.message);
        throw error;
    }
}

document.addEventListener('DOMContentLoaded', () => {
    checkSession();
    document.getElementById('login-form').addEventListener('submit', e => {
        e.preventDefault();
        login(document.getElementById('username').value, document.getElementById('password').value);
    });
    document.getElementById('searchInput').addEventListener('input', e => filtrarContenido(e.target.value));
});

async function checkSession() {
    const sessionData = localStorage.getItem(SESSION_KEY);
    if (sessionData) {
        await initializeAppData(JSON.parse(sessionData));
    } else {
        showLoginHideApp();
    }
}

async function login(username, password) {
    try {
        const result = await postToAction('login', { username, password });
        localStorage.setItem(SESSION_KEY, JSON.stringify(result.user));
        await initializeAppData(result.user);
    } catch (error) { /* Handled in postToAction */ }
}

async function initializeAppData(user) {
    hideLoginShowApp();
    document.getElementById('welcome-message').textContent = `Bienvenido, ${user.nombre}`;
    showSkeletonLoader(document.getElementById('contenido'));
    try {
        const result = await postToAction('getCatalogData');
        datosOriginales = result.data.cortes || [];
        datosTutoriales = result.data.tutoriales || [];
        datosRelay = result.data.relay || [];
        mostrarCategorias();
    } catch (error) {
        document.getElementById('contenido').innerHTML = `<p>Error al cargar el catálogo.</p>`;
    }
}

function showLoginHideApp() {
    document.getElementById('splash-screen').style.display = 'none';
    document.getElementById('login-modal').style.display = 'flex';
}

function hideLoginShowApp() {
    document.getElementById('splash-screen').style.display = 'none';
    document.getElementById('login-modal').style.display = 'none';
    document.querySelector('.container').style.display = 'block';
    document.querySelector('.footer').style.display = 'block';
}

function showSkeletonLoader(container) {
    container.innerHTML = '<div class="skeleton-grid">' + Array(10).fill('<div class="skeleton-card"></div>').join('') + '</div>';
}

function convertirAGoogleThumbnail(url){
    if(!url) return "https://placehold.co/280x200?text=Sin+Imagen";
    const idMatch = url.match(/id=([a-zA-Z0-9_-]+)/) || url.match(/\/d\/([a-zA-Z0-9_-]+)/);
    return idMatch ? `https://drive.google.com/thumbnail?sz=w1000&id=${idMatch[1]}` : url;
}

function renderGrid(items, title) {
    const cont = document.getElementById("contenido");
    const gridHtml = items.map(item => `
        <div class="card" onclick="${item.onclick}">
            <img src="${convertirAGoogleThumbnail(item.imgUrl)}" alt="${item.label}">
            <div class="overlay">${item.label}</div>
        </div>
    `).join('');
    cont.innerHTML = `<h4>${title}</h4><div class="grid">${gridHtml}</div>`;
}

function filtrarContenido(texto) {
    const busqueda = texto.toLowerCase().trim();
    if (!busqueda) {
        mostrarCategorias();
        return;
    }
    const palabras = busqueda.split(' ').filter(p => p);
    datosFiltrados = datosOriginales.filter(fila => {
        const textoFila = `${fila.categoria} ${fila.marca} ${fila.modelo} ${fila.anoGeneracion}`.toLowerCase();
        return palabras.every(p => textoFila.includes(p));
    });
    renderGrid(datosFiltrados.map(fila => ({
        label: `${fila.marca}<br>${fila.modelo}`,
        imgUrl: fila.imagenDelVehiculo,
        onclick: `mostrarDetalleModal('${fila.id}')`
    })), 'Resultados de Búsqueda');
}

function mostrarCategorias() {
    const categorias = [...new Set(datosOriginales.map(f => f.categoria))].filter(Boolean).sort();
    renderGrid(categorias.map(cat => {
        const ejemplo = datosOriginales.find(f => f.categoria === cat);
        return {
            label: cat,
            imgUrl: ejemplo.imagenDelVehiculo,
            onclick: `mostrarMarcas('${cat}')`
        };
    }), 'Categorías');
}

function mostrarMarcas(categoria) {
    const marcas = [...new Set(datosOriginales.filter(f => f.categoria === categoria).map(f => f.marca))].filter(Boolean).sort();
    renderGrid(marcas.map(marca => {
        const ejemplo = datosOriginales.find(f => f.marca === marca && f.categoria === categoria);
        return {
            label: marca,
            imgUrl: ejemplo.imagenDelVehiculo,
            onclick: `mostrarModelos('${categoria}', '${marca}')`
        };
    }), `Marcas de ${categoria}`);
}

function mostrarModelos(categoria, marca) {
    const modelosRaw = datosOriginales.filter(f => f.categoria === categoria && f.marca === marca);
    const modelosUnicos = [...new Set(modelosRaw.map(f => f.modelo))].filter(Boolean).sort();
    renderGrid(modelosUnicos.map(modelo => {
        const ejemplo = modelosRaw.find(f => f.modelo === modelo);
        const versiones = modelosRaw.filter(f => f.modelo === modelo);
        return {
            label: `${modelo} ${versiones.length > 1 ? `(${versiones.length})` : ''}`,
            imgUrl: ejemplo.imagenDelVehiculo,
            onclick: versiones.length > 1 ? `mostrarVersiones('${categoria}', '${marca}', '${modelo}')` : `mostrarDetalleModal('${ejemplo.id}')`
        };
    }), `Modelos de ${marca}`);
}

function mostrarVersiones(categoria, marca, modelo) {
    const versiones = datosOriginales.filter(f => f.categoria === categoria && f.marca === marca && f.modelo === modelo);
    renderGrid(versiones.map(v => ({
        label: v.anoGeneracion || 'Detalle',
        imgUrl: v.imagenDelVehiculo,
        onclick: `mostrarDetalleModal('${v.id}')`
    })), `Versiones de ${modelo}`);
}

function mostrarDetalleModal(id) {
    const fila = datosOriginales.find(f => f.id == id);
    if (!fila) return;
    const modal = document.getElementById("modalDetalle");
    const cont = document.getElementById("detalleCompleto");
    cont.innerHTML = `<h2>${fila.marca} ${fila.modelo}</h2><p>${fila.descripcionDelCorte || ''}</p>`; // Simplified for now
    modal.style.display = 'block';
    // Add close button logic
    cont.innerHTML += `<button onclick="document.getElementById('modalDetalle').style.display='none'">Cerrar</button>`;
}

function showCustomAlert(msg) { alert(msg); }
</script>
</body>
</html>
