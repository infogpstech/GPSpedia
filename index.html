<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>GPSpedia | Catálogo Técnico</title>
<link rel="icon" href="https://drive.google.com/thumbnail?id=1NxBx-W_gWmcq3fA9zog6Dpe-WXpH_2e8&sz=w256">
<link rel="manifest" href="manifest.json">
<style>
/* Estilos Globales */
html {
    height: 100%;
}
body {
    font-family: Arial, sans-serif;
    margin: 0;
    padding: 0;
    background: #f4f4f4;
    display: flex;
    flex-direction: column;
    min-height: 100%;
}
h1,h2,h3,h4 {
    margin: 10px 0;
}
.container {
    padding: 20px;
    max-width: 1240px;
    margin: 0 auto;
    width: 100%;
    box-sizing: border-box;
    flex: 1 0 auto;
}
.backBtn {
    margin-bottom: 15px;
    cursor: pointer;
    color: #007bff;
    display: inline-flex;
    align-items: center;
    font-weight: bold;
    padding: 5px 10px;
    border-radius: 5px;
    transition: background 0.2s;
}
.backBtn:hover {
    background: #e9f7ff;
}

/* --- ESTILOS DEL ENCABEZADO (Header) --- */
.header-container {
    display: flex;
    align-items: center;
    justify-content: flex-start;
    margin-bottom: 20px;
}
.app-logo {
    max-width: 96px;
    height: auto;
    border-radius: 8px;
    margin-right: 15px;
}
h1.app-title {
    text-align: left;
    margin: 0;
    font-size: 2.2em;
    color: #333;
}

/* --- ESTILOS DEL BUSCADOR --- */
.search-container {
    margin-bottom: 30px;
    padding: 10px 0;
    max-width: 600px;
    margin-left: auto;
    margin-right: auto;
}
.search-container label {
    display: block;
    font-size: 1.1em;
    font-weight: bold;
    color: #555;
    margin-bottom: 8px;
}
.search-container input[type="text"] {
    width: 100%;
    padding: 12px 15px;
    border: 1px solid #ccc;
    border-radius: 8px;
    box-sizing: border-box;
    font-size: 1em;
    transition: border-color 0.3s, box-shadow 0.3s;
}
.search-container input[type="text"]:focus {
    border-color: #007bff;
    box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.25);
    outline: none;
}

/* --- ESTILOS DE LA SELECCIÓN DE SECCIÓN --- */
.section-selector {
    display: flex;
    justify-content: center;
    margin-bottom: 20px;
}
.section-btn {
    background-color: #f0f0f0;
    border: 1px solid #ccc;
    border-radius: 8px;
    padding: 10px 20px;
    margin: 0 5px;
    cursor: pointer;
    font-size: 1em;
    transition: background-color 0.3s, color 0.3s;
}
.section-btn.active {
    background-color: #007bff;
    color: #fff;
    border-color: #007bff;
}
.section-btn:hover:not(.active) {
    background-color: #e0e0e0;
}


/* Estilos de la Cuadrícula */
.grid {
    display: grid;
    gap: 20px;
    grid-template-columns: repeat(auto-fit, 140px);
    justify-content: center;
    max-width: 1200px;
    margin: 0 auto;
}

/* Estilos de la Tarjeta (Card) */
.card {
    position: relative;
    background: #fff;
    border-radius: 12px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    cursor: pointer;
    padding: 0;
    overflow: hidden;
    transition: transform 0.3s ease, box-shadow 0.3s ease;
    width: 100%;
    max-width: 140px;
    justify-self: center;
}
.card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
}
.card img {
    width: 100%;
    height: 120px;
    object-fit: contain;
    display: block;
    border-radius: 0;
}
.overlay {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    background: linear-gradient(to top, rgba(0, 0, 0, 0.9) 0%, rgba(0, 0, 0, 0) 100%);
    color: #fff;
    padding: 10px 8px 8px 8px;
    font-size: 0.9em;
    line-height: 1.3;
    font-weight: bold;
    border-radius: 0;
    z-index: 10;
}

/* Modal */
#modalDetalle{
    display:none;
    position:fixed;
    top:0;
    left:0;
    width:100%;
    height:100%;
    overflow:auto;
    background:rgba(0,0,0,0.8);
    color:#000;
    z-index:999;
}
#detalleCompleto{
    background:#fff;
    margin:50px auto;
    padding:30px;
    max-width:90%;
    border-radius:15px;
    box-shadow: 0 0 20px rgba(0,0,0,0.5);
    max-height: 90vh;
    overflow-y: auto;
}
#detalleCompleto img{
    max-width:100%;
    max-height:60vh;
    margin-bottom:15px;
    cursor:pointer;
    object-fit:contain;
    border-radius:8px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}
#detalleCompleto h4 {
    color: #007bff;
    border-bottom: 2px solid #eee;
    padding-bottom: 5px;
}

/* Lightbox */
.lightbox{
    position:fixed;
    top:0;
    left:0;
    width:100%;
    height:100%;
    background:rgba(0,0,0,0.9);
    display:flex;
    align-items:center;
    justify-content:center;
    z-index:1000;
}
.lightbox img{max-width:95%; max-height:95%;}

.footer {
    text-align: center;
    padding: 20px 0;
    margin-top: 40px;
    background-color: #333;
    color: #fff;
    font-size: 0.9em;
}
</style>
</head>
<body>

<div class="container">

  <div class="header-container">
      <img src="https://drive.google.com/thumbnail?id=1NxBx-W_gWmcq3fA9zog6Dpe-WXpH_2e8&sz=2048" alt="Logo de GPSpedia" class="app-logo">
      <h1 class="app-title">GPSpedia</h1>
  </div>

  <div class="search-container">
      <label for="searchInput">Buscar Corte</label>
      <input type="text" id="searchInput" placeholder="Escribe marca, modelo, año o categoría..." oninput="filtrarContenido(this.value)">
  </div>

  <div class="section-selector">
      <button id="btn-cortes" class="section-btn active" onclick="mostrarSeccion('cortes')">Cortes</button>
      <button id="btn-tutoriales" class="section-btn" onclick="mostrarSeccion('tutoriales')">Tutoriales</button>
      <button id="btn-relay" class="section-btn" onclick="mostrarSeccion('relay')">Relay</button>
  </div>

  <div id="contenido" class="content-section"></div>
  <div id="contenido-tutoriales" class="content-section" style="display: none;"></div>
  <div id="contenido-relay" class="content-section" style="display: none;"></div>
</div>

<div id="modalDetalle">
  <div id="detalleCompleto"></div>
</div>

<div id="lightbox" class="lightbox" style="display:none;" onclick="cerrarLightbox()">
  <img id="lightboxImg" src="">
</div>

<script>
// Bloqueo de teclas para seguridad
document.addEventListener('keydown', function(e) {
    if (e.key === 'F12' || (e.ctrlKey && e.key === 'u') || (e.ctrlKey && e.shiftKey && (e.key === 'I' || e.key === 'i'))) {
        e.preventDefault();
    }
});
document.addEventListener('contextmenu', function(e) {
    e.preventDefault();
});

function mostrarSeccion(seccion) {
    document.getElementById('contenido').style.display = 'none';
    document.getElementById('contenido-tutoriales').style.display = 'none';
    document.getElementById('contenido-relay').style.display = 'none';

    document.getElementById('btn-cortes').classList.remove('active');
    document.getElementById('btn-tutoriales').classList.remove('active');
    document.getElementById('btn-relay').classList.remove('active');

    if (seccion === 'cortes') {
        document.getElementById('contenido').style.display = 'block';
        document.getElementById('btn-cortes').classList.add('active');
    } else if (seccion === 'tutoriales') {
        document.getElementById('contenido-tutoriales').style.display = 'block';
        document.getElementById('btn-tutoriales').classList.add('active');
        if (datosTutoriales.length === 0) fetchData(RANGE_TUTORIALES, (vals) => datosTutoriales = vals, mostrarContenidoTutoriales, 'contenido-tutoriales');
    } else if (seccion === 'relay') {
        document.getElementById('contenido-relay').style.display = 'block';
        document.getElementById('btn-relay').classList.add('active');
        if (datosRelay.length === 0) fetchData(RANGE_RELAY, (vals) => datosRelay = vals, mostrarContenidoRelay, 'contenido-relay');
    }
}

// CONFIGURACIÓN DE LA HOJA DE CÁLCULO
const SPREADSHEET_ID = "1jEdC2NMc2a5F36xE2MJfgxMZiZFVfeDqnCdVizNGIMo";
const API_KEY = "AIzaSyCooAsC52X4ccENCT6p3qh_82ErBxP47Lg";
const RANGE_CORTES = "Cortes";
const RANGE_TUTORIALES = "Tutorial";
const RANGE_RELAY = "Configuración del Relay";

const COLUMN_NAME_AÑOS = "Año (generacion)";

let datosOriginales = [], datosFiltrados = [], datosTutoriales = [], datosRelay = [],
    estado = {nivel:"categorias", categoria:null, marca:null, modelo:null};

const backSvg = '<svg style="width:20px;height:20px;margin-right:5px;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"></polyline></svg>';

// --- FUNCIONES DE CARGA DE DATOS ---
function fetchData(range, dataVariableSetter, successCallback, containerId) {
    fetch(`https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${encodeURIComponent(range)}?key=${API_KEY}`)
        .then(res => {
            if (!res.ok) throw new Error(`Error ${res.status}: Fallo al cargar la hoja '${range}'.`);
            return res.json();
        })
        .then(data => {
            const values = data.values || [];
            if (values.length === 0) {
                document.getElementById(containerId).innerHTML = `<p>No se encontraron datos en '${range}'.</p>`;
                return;
            }
            dataVariableSetter(values);
            successCallback();
        })
        .catch(err => {
            console.error(`Error al cargar datos de ${range}:`, err);
            document.getElementById(containerId).innerHTML = `<p style="color:red;">Error al cargar datos: ${err.message}</p>`;
        });
}

// --- FUNCIONES DE RENDERIZADO ---
function mostrarContenidoTutoriales() {
    const cont = document.getElementById("contenido-tutoriales");
    cont.innerHTML = "<h4>Tutoriales</h4>";
    const grid = document.createElement("div"); grid.className = "grid";
    if (datosTutoriales.length <= 1) { cont.innerHTML += "<p>No hay tutoriales disponibles.</p>"; return; }
    const header = datosTutoriales[0];
    const data = datosTutoriales.slice(1);

    data.forEach(fila => {
        const card = document.createElement("div"); card.className = "card";
        card.onclick = () => mostrarDetalleTutorial(fila, header);

        const img = document.createElement("img");
        img.src = convertirAGoogleThumbnail(fila[header.indexOf("Imagen")]);
        img.alt = fila[header.indexOf("Tema")];
        card.appendChild(img);

        const overlay = document.createElement("div"); overlay.className = "overlay";
        overlay.innerHTML = fila[header.indexOf("Tema")];
        card.appendChild(overlay);
        grid.appendChild(card);
    });
    cont.appendChild(grid);
}

function mostrarContenidoRelay() {
    const cont = document.getElementById("contenido-relay");
    cont.innerHTML = "<h4>Configuración del Relay</h4>";
    const grid = document.createElement("div"); grid.className = "grid";
    if (datosRelay.length <= 1) { cont.innerHTML += "<p>No hay configuraciones de relay disponibles.</p>"; return; }
    const header = datosRelay[0];
    const data = datosRelay.slice(1);

    data.forEach(fila => {
        const card = document.createElement("div"); card.className = "card";
        card.onclick = () => mostrarDetalleRelay(fila, header);

        const img = document.createElement("img");
        img.src = convertirAGoogleThumbnail(fila[header.indexOf("Imagen")]);
        img.alt = fila[header.indexOf("Configuración")];
        card.appendChild(img);

        const overlay = document.createElement("div"); overlay.className = "overlay";
        overlay.innerHTML = fila[header.indexOf("Configuración")];
        card.appendChild(overlay);
        grid.appendChild(card);
    });
    cont.appendChild(grid);
}

// --- FUNCIONES DE DETALLE (MODAL) ---
function crearElementoDetalle(label, value) {
    if (!value) return null;
    const p = document.createElement("p");
    p.innerHTML = `<strong>${label}:</strong> ${value}`;
    return p;
}

function crearImagenDetalle(label, value, container) {
    if (!value) return;
    const h = document.createElement("h4");
    h.textContent = label;
    container.appendChild(h);
    const img = document.createElement("img");
    img.src = convertirAGoogleThumbnail(value);
    img.alt = label;
    img.onclick = () => mostrarLightbox(value);
    container.appendChild(img);
}

function crearVideoDetalle(label, value, container) {
    if (!value) return;
    const videoId = extractYouTubeId(value.trim());
    if (!videoId) return;

    const h = document.createElement("h4");
    h.textContent = label;
    container.appendChild(h);
    const iframeContainer = document.createElement("div");
    iframeContainer.style.cssText = "position:relative; padding-bottom:56.25%; height:0; margin-bottom:20px;";
    const iframe = document.createElement("iframe");
    iframe.src = `https://www.youtube.com/embed/${videoId}`;
    iframe.title = label;
    iframe.allow = "accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture";
    iframe.allowFullscreen = true;
    iframe.style.cssText = "border:none; position:absolute; top:0; left:0; width:100%; height:100%;";
    iframeContainer.appendChild(iframe);
    container.appendChild(iframeContainer);
}


function mostrarDetalleTutorial(fila, header) {
    const modal = document.getElementById("modalDetalle");
    const cont = document.getElementById("detalleCompleto");
    cont.innerHTML = "";

    const closeBtn = document.createElement("button");
    closeBtn.textContent = "Cerrar Detalle";
    closeBtn.onclick = cerrarModal;
    closeBtn.className = "backBtn";
    closeBtn.style.cssText = "color:white; background:#dc3545; border:none; margin-bottom:20px;";
    cont.appendChild(closeBtn);

    const title = document.createElement("h2");
    title.textContent = fila[header.indexOf("Tema")];
    title.style.cssText = "color:#007bff; border-bottom:3px solid #007bff; padding-bottom:10px;";
    cont.appendChild(title);

    const campos = [
        { label: "Cómo identificarlo", key: "Como identificarlo" },
        { label: "Dónde encontrarlo", key: "Donde encontrarlo" },
        { label: "Detalles", key: "Detalles" }
    ];

    campos.forEach(c => {
        const p = crearElementoDetalle(c.label, fila[header.indexOf(c.key)]);
        if (p) cont.appendChild(p);
    });

    crearImagenDetalle("Imagen", fila[header.indexOf("Imagen")], cont);
    crearVideoDetalle("Video Guía", fila[header.indexOf("Video")], cont);

    const closeBtnBottom = closeBtn.cloneNode(true);
    closeBtnBottom.onclick = cerrarModal;
    cont.appendChild(closeBtnBottom);
    modal.style.display = "flex";
}

function mostrarDetalleRelay(fila, header) {
    const modal = document.getElementById("modalDetalle");
    const cont = document.getElementById("detalleCompleto");
    cont.innerHTML = "";

    const closeBtn = document.createElement("button");
    closeBtn.textContent = "Cerrar Detalle";
    closeBtn.onclick = cerrarModal;
    closeBtn.className = "backBtn";
    closeBtn.style.cssText = "color:white; background:#dc3545; border:none; margin-bottom:20px;";
    cont.appendChild(closeBtn);

    const title = document.createElement("h2");
    title.textContent = `Detalle de: ${fila[header.indexOf("Configuración")]}`;
    title.style.cssText = "color:#007bff; border-bottom:3px solid #007bff; padding-bottom:10px;";
    cont.appendChild(title);

    const campos = [
        { label: "Función", key: "Función" },
        { label: "Vehículo donde se utiliza", key: "Vehiculo donde se utiliza" },
        { label: "PIN 30 (entrada)", key: "PIN 30 (entrada)" },
        { label: "PIN 85 (bobina +)", key: "PIN 85 (bobina +)" },
        { label: "PIN 86 (bobina - )", key: "PIN 86 (bobina - )" },
        { label: "PIN 87a (comun cerrado)", key: "PIN 87a (comun cerrado)" },
        { label: "PIN 87 (Comunmente Abierto)", key: "PIN 87 (Comunmente Abierto)" },
        { label: "Observación", key: "Observacion" }
    ];

    campos.forEach(c => {
        const p = crearElementoDetalle(c.label, fila[header.indexOf(c.key)]);
        if (p) cont.appendChild(p);
    });

    crearImagenDetalle("Imagen", fila[header.indexOf("Imagen")], cont);

    const closeBtnBottom = closeBtn.cloneNode(true);
    closeBtnBottom.onclick = cerrarModal;
    cont.appendChild(closeBtnBottom);
    modal.style.display = "flex";
}

// --- FUNCIONES ORIGINALES DE CORTES ---
function getHeaderIndexes(header) {
    if (!header || header.length < 5) {
        console.error("Error: Encabezado de datos incompleto o no cargado.");
        return { COL_CAT: 1, COL_MARCA: 3, COL_MODELO: 4, COL_AÑOS: 6, COL_IMG_VEHICULO: 2, COL_IMG_PORTADA: -1, COL_IMG_APERTURA: 14, COL_TIPO_ENCENDIDO: 5 };
    }
    const indexAños = header.indexOf(COLUMN_NAME_AÑOS);
    return {
        COL_CAT: header.indexOf("Categoria"), COL_MARCA: header.indexOf("Marca"), COL_MODELO: header.indexOf("Modelo"),
        COL_AÑOS: (indexAños > -1) ? indexAños : 6, COL_TIPO_ENCENDIDO: header.indexOf("Tipo de encendido"),
        COL_IMG_VEHICULO: header.indexOf("Imagen del vehiculo"), COL_IMG_PORTADA: header.indexOf("Imagen de la portada"),
        COL_IMG_APERTURA: header.indexOf("Imagen de la apertura"),
    };
}

function convertirAGoogleThumbnail(url){
  if(!url) return "https://placehold.co/280x200/cccccc/333333?text=Sin+Imagen";
  let idMatch = url.match(/id=([a-zA-Z0-9_-]+)/) || url.match(/\/d\/([a-zA-Z0-9_-]+)/);
  if(idMatch) return `https://drive.google.com/thumbnail?sz=w1000&id=${idMatch[1]}`;
  return url;
}

function mostrarLightbox(src){
  let idMatch = src.match(/id=([a-zA-Z0-9_-]+)/) || src.match(/\/d\/([a-zA-Z0-9_-]+)/);
  let finalUrl = src;
  if(idMatch && idMatch[1]){
      finalUrl = `https://drive.google.com/thumbnail?id=${idMatch[1]}&sz=w2000`;
  } else {
       console.warn("Advertencia: No se pudo encontrar un ID de Google Drive válido para el Lightbox. Usando URL original.");
  }
  document.getElementById("lightboxImg").src = finalUrl;
  document.getElementById("lightbox").style.display="flex";
}
function cerrarModal(){ document.getElementById("modalDetalle").style.display="none"; }
function cerrarLightbox(){document.getElementById("lightbox").style.display="none";}

function extractYouTubeId(url) {
    if (!url) return null;
    let videoId = null;
    try {
        const urlObj = new URL(url);
        if (urlObj.hostname.includes('youtube.com') && urlObj.searchParams.get('v')) {
            videoId = urlObj.searchParams.get('v');
        } else if (urlObj.hostname.includes('youtu.be') && urlObj.pathname.length > 1) {
            videoId = urlObj.pathname.substring(1);
        } else if (urlObj.pathname.includes('/embed/') && urlObj.pathname.length > 7) {
            const parts = urlObj.pathname.split('/embed/');
            if (parts.length > 1) videoId = parts[1].split(/[?&]/)[0];
        }
    } catch (e) { return null; }
    return videoId;
}

function mostrarDetalleModal(fila, header){
  const modal = document.getElementById("modalDetalle");
  const cont = document.getElementById("detalleCompleto");
  cont.innerHTML = "";
  const indexes = getHeaderIndexes(header);

  const closeBtn = document.createElement("button");
  closeBtn.textContent = "Cerrar Detalle";
  closeBtn.onclick = cerrarModal;
  closeBtn.className = "backBtn";
  closeBtn.style.cssText = "color:white; background:#dc3545; border:none; margin-bottom:20px;";
  cont.appendChild(closeBtn);

  const title = document.createElement("h2");
  const modeloNombre = fila[indexes.COL_MODELO] || 'Modelo Desconocido';
  const anosNombre = fila[indexes.COL_AÑOS] || '';
  title.textContent = `Detalle de ${modeloNombre} ${anosNombre ? `(${anosNombre})` : ''}`;
  title.style.cssText = "color:#007bff; border-bottom:3px solid #007bff; padding-bottom:10px;";
  cont.appendChild(title);

  const campos = [
    {label:"Nota Importante", key:"Nota Importante", isTitle: true}, {label:"Modelo", key:"Imagen del vehiculo"},
    {label:"Tipo de Corte", key:"Tipo de corte"}, {label:"Descripción", key:"Descripcion del corte"},
    {label:"Imagen", key:"Imagen del Corte"}, {label:"Segunda Opción", key:"Tipo de corte 2"},
    {label:"Segunda Descripción:", key:"Descripción del Segundo corte"}, {label:"Imagen del Segundo Corte", key:"Imagen de corte 2"},
    {label:"Apertura", key:"Apertura"}, {label:"Imagen de la Apertura", key:"Imagen de la apertura"},
    {label:"Alimentación", key:"Cables de Alimentacion"}, {label:"Imagen de Alimentación", key:"Imagen de los cables de alimentacion"},
    {label:"Imagen de la portada (Alternativa)", key:"Imagen de la portada"}
  ];

  campos.forEach(c => {
    let index = header.indexOf(c.key);
    if(index > -1){
        let valor = fila[index];
        if(valor){
            if(c.key.includes("Imagen")){
                crearImagenDetalle(c.label, valor, cont);
            } else {
                const p=document.createElement("p");
                if(c.isTitle){
                    p.innerHTML = `<strong style="color:red;">${c.label}:</strong> <span style="color:#cc0000; font-weight: bold;">${valor}</span>`;
                } else {
                    p.innerHTML=`<strong>${c.label}:</strong> ${valor}`;
                }
                cont.appendChild(p);
            }
        }
    }
  });

  crearVideoDetalle("Video Guía de Desarme", fila[header.indexOf("Como desarmar los plasticos")], cont);

  const closeBtnBottom = closeBtn.cloneNode(true);
  closeBtnBottom.onclick = cerrarModal;
  cont.appendChild(closeBtnBottom);
  modal.style.display="flex";
}

function filtrarContenido(textoBusqueda){
    const busqueda = textoBusqueda.toLowerCase().trim();
    if (busqueda.length === 0) {
        datosFiltrados = [];
        estado.nivel = "categorias";
        mostrarCategorias();
        return;
    }
    const header = datosOriginales[0];
    const indexes = getHeaderIndexes(header);
    const dataToFilter = datosOriginales.slice(1);
    const palabrasBusqueda = busqueda.split(' ').filter(p => p.length > 0);
    datosFiltrados = dataToFilter.filter(fila => {
        const filaTexto = [
            fila[indexes.COL_CAT], fila[indexes.COL_MARCA], fila[indexes.COL_MODELO],
            fila[indexes.COL_AÑOS], fila[indexes.COL_TIPO_ENCENDIDO]
        ].map(s => (s || '').toLowerCase()).join(' ');
        return palabrasBusqueda.every(palabra => filaTexto.includes(palabra));
    });
    if(datosFiltrados.length > 0){
        mostrarResultadosBusquedaMarca(busqueda);
    } else {
        document.getElementById("contenido").innerHTML = `<p style="text-align:center; padding: 20px;">No se encontraron resultados para "${busqueda}".</p>`;
    }
    estado.nivel = "busqueda";
    estado.categoria = null; estado.marca = null; estado.modelo = null;
}

function mostrarResultadosBusquedaMarca(busquedaTexto){
    const cont = document.getElementById("contenido");
    const header = datosOriginales[0];
    const indexes = getHeaderIndexes(header);
    if (datosFiltrados.length === 1) {
        const anosRaw = (datosFiltrados[0][indexes.COL_AÑOS] || '').trim();
        mostrarDetalleModal(datosFiltrados[0], header);
        cont.innerHTML = `<h4>Resultado Exacto Encontrado</h4><p>Abriendo detalle de ${datosFiltrados[0][indexes.COL_MODELO]} ${anosRaw ? `(${anosRaw})` : ''}.</p>`;
        return;
    }
    cont.innerHTML = `<h4>Resultados de búsqueda para: "${busquedaTexto}"</h4>`;
    const marcasUnicas = [...new Set(datosFiltrados.map(f => f[indexes.COL_MARCA]))].filter(m => m).sort();
    const grid = document.createElement("div"); grid.className = "grid";
    marcasUnicas.forEach(marca => {
        const ejemplo = datosFiltrados.find(f => f[indexes.COL_MARCA] === marca && f[indexes.COL_IMG_VEHICULO]) || datosFiltrados.find(f => f[indexes.COL_MARCA] === marca);
        const card=document.createElement("div"); card.className="card";
        card.onclick=()=>mostrarResultadosBusquedaModelo(busquedaTexto, marca);
        const imgUrl = ejemplo ? ejemplo[indexes.COL_IMG_VEHICULO] : '';
        const img=document.createElement("img"); img.src=convertirAGoogleThumbnail(imgUrl); img.alt=`Marca ${marca}`; card.appendChild(img);
        const overlay=document.createElement("div"); overlay.className="overlay"; overlay.innerHTML = marca; card.appendChild(overlay);
        grid.appendChild(card);
    });
    cont.appendChild(grid);
}

function mostrarResultadosBusquedaModelo(busquedaTexto, marcaFiltro){
    const header = datosOriginales[0];
    const indexes = getHeaderIndexes(header);
    const cont = document.getElementById("contenido");
    cont.innerHTML = `<span class="backBtn" onclick="mostrarResultadosBusquedaMarca('${busquedaTexto}')">${backSvg} Volver a Marcas</span>
                      <h4>Modelos de ${marcaFiltro} (Búsqueda: "${busquedaTexto}")</h4>`;
    const modelosRaw = datosFiltrados.filter(f => f[indexes.COL_MARCA] === marcaFiltro);
    const modelosRenderizar = {};
    modelosRaw.forEach(f => { const nombre = f[indexes.COL_MODELO]; if (!modelosRenderizar[nombre]) modelosRenderizar[nombre] = f; });
    const grid=document.createElement("div"); grid.className = "grid";
    Object.keys(modelosRenderizar).sort().forEach(modelo => {
        const ejemplo = modelosRenderizar[modelo];
        const versiones = modelosRaw.filter(f => f[indexes.COL_MODELO] === modelo);
        const card=document.createElement("div"); card.className="card";
        card.onclick=()=>{
            if(versiones.length===1) mostrarDetalleModal(ejemplo, header);
            else mostrarResultadosBusquedaVersion(busquedaTexto, marcaFiltro, modelo);
        };
        const imgUrl = ejemplo[indexes.COL_IMG_VEHICULO];
        const img=document.createElement("img"); img.src=convertirAGoogleThumbnail(imgUrl); img.alt=`Modelo ${modelo}`; card.appendChild(img);
        const overlay=document.createElement("div"); overlay.className="overlay";
        const anos = ejemplo[indexes.COL_AÑOS] || '';
        const encendido = ejemplo[indexes.COL_TIPO_ENCENDIDO] || '';
        if(versiones.length === 1) {
            overlay.innerHTML = `<div>${modelo}</div>
                                 ${anos ? `<div style="font-size:0.8em; opacity:0.8; font-weight:normal;">${anos}</div>` : ''}
                                 ${encendido ? `<div style="font-size:0.8em; opacity:0.8; font-weight:normal;">${encendido}</div>` : ''}`;
        } else {
            overlay.innerHTML = `<div>${modelo}</div>
                                 <div style="font-size:0.8em; opacity:0.8; font-weight:normal;">(${versiones.length} cortes)</div>`;
        }
        card.appendChild(overlay);
        grid.appendChild(card);
    });
    cont.appendChild(grid);
}

function mostrarResultadosBusquedaVersion(busquedaTexto, marcaFiltro, modeloFiltro){
    const header = datosOriginales[0];
    const indexes = getHeaderIndexes(header);
    const cont = document.getElementById("contenido");
    cont.innerHTML = `<span class="backBtn" onclick="mostrarResultadosBusquedaModelo('${busquedaTexto}', '${marcaFiltro}')">${backSvg} Volver a Modelos (${modeloFiltro})</span>
                      <h4>Cortes/Años de ${modeloFiltro} (Búsqueda: "${busquedaTexto}")</h4>`;
    const filasDetalle = datosFiltrados.filter(f => f[indexes.COL_MARCA] === marcaFiltro && f[indexes.COL_MODELO] === modeloFiltro);
    const grid=document.createElement("div"); grid.className="grid";
    filasDetalle.forEach(f => {
        const card=document.createElement("div"); card.className="card";
        const imgUrl = f[indexes.COL_IMG_VEHICULO];
        const img=document.createElement("img"); img.src=convertirAGoogleThumbnail(imgUrl); img.alt=`Corte ${f[indexes.COL_AÑOS]}`; card.appendChild(img);
        const overlay=document.createElement("div"); overlay.className="overlay";
        const anosRaw = (f[indexes.COL_AÑOS] || '').trim();
        const encendido = (f[indexes.COL_TIPO_ENCENDIDO] || '').trim();
        let mainTitle = anosRaw || modeloFiltro;
        overlay.innerHTML = `<div style="font-weight:bold;">${mainTitle}</div>
                             ${encendido ? `<div style="font-size:0.8em; opacity:0.8;">${encendido}</div>` : ''}`;
        card.appendChild(overlay);
        card.onclick=()=>mostrarDetalleModal(f, header);
        grid.appendChild(card);
    });
    cont.appendChild(grid);
}

function mostrarCategorias(){
  if(document.getElementById("searchInput").value.trim().length > 0) return;
  estado.nivel="categorias"; estado.categoria=null;
  const cont=document.getElementById("contenido"); cont.innerHTML="<h4>Categorías</h4>";
  if (datosOriginales.length <= 1) {
    cont.innerHTML = '<p style="color:red; font-size:1.2em;">Advertencia: La hoja de cálculo está vacía o el rango es incorrecto.</p>';
    return;
  }
  const header = datosOriginales[0];
  const indexes = getHeaderIndexes(header);
  const categorias = [...new Set(datosOriginales.slice(1).map(f=>f[indexes.COL_CAT]))].filter(c => c).sort();
  const grid = document.createElement("div"); grid.className="grid";
  categorias.forEach(cat=>{
    const ejemplo = datosOriginales.slice(1).find(f=>f[indexes.COL_CAT]===cat);
    const card=document.createElement("div"); card.className="card";
    card.onclick=()=>mostrarMarcas(cat);
    const imgUrl = ejemplo ? ejemplo[indexes.COL_IMG_VEHICULO] : '';
    const img=document.createElement("img"); img.src=convertirAGoogleThumbnail(imgUrl); img.alt=`Imagen de la categoría ${cat}`; card.appendChild(img);
    const overlay=document.createElement("div"); overlay.className="overlay"; overlay.innerHTML = cat; card.appendChild(overlay);
    grid.appendChild(card);
  });
  cont.appendChild(grid);
}

function mostrarMarcas(categoria){
  document.getElementById("searchInput").value = "";
  estado.nivel="marcas"; estado.categoria=categoria;
  const cont=document.getElementById("contenido");
  cont.innerHTML=`<span class="backBtn" onclick="mostrarCategorias()">${backSvg} Volver a Categorías</span><h4>Marcas de ${categoria}</h4>`;
  const header = datosOriginales[0];
  const indexes = getHeaderIndexes(header);
  const marcas = [...new Set(datosOriginales.slice(1).filter(f=>f[indexes.COL_CAT]===categoria).map(f=>f[indexes.COL_MARCA]))].filter(m => m).sort();
  const grid = document.createElement("div"); grid.className="grid";
  marcas.forEach(m=>{
    const ejemplo = datosOriginales.slice(1).find(f=>f[indexes.COL_CAT]===categoria && f[indexes.COL_MARCA]===m);
    const card=document.createElement("div"); card.className="card";
    card.onclick=()=>mostrarModelos(categoria,m);
    const imgUrl = ejemplo ? ejemplo[indexes.COL_IMG_VEHICULO] : '';
    const img=document.createElement("img"); img.src=convertirAGoogleThumbnail(imgUrl); img.alt=`Imagen de la marca ${m}`; card.appendChild(img);
    const overlay=document.createElement("div"); overlay.className="overlay"; overlay.innerHTML = m; card.appendChild(overlay);
    grid.appendChild(card);
  });
  cont.appendChild(grid);
}

function mostrarModelos(categoria, marca){
  estado.nivel="modelos"; estado.marca=marca;
  document.getElementById("searchInput").value = "";
  const cont=document.getElementById("contenido");
  cont.innerHTML=`<span class="backBtn" onclick="mostrarMarcas('${categoria}')">${backSvg} Volver a Marcas</span><h4>Modelos de ${marca}</h4>`;
  const header = datosOriginales[0];
  const indexes = getHeaderIndexes(header);
  const modelosRaw = datosOriginales.slice(1).filter(f=>f[indexes.COL_CAT]===categoria && f[indexes.COL_MARCA]===marca);
  const modelosRenderizar = {};
  modelosRaw.forEach(f=>{ const nombre = f[indexes.COL_MODELO]; if(!modelosRenderizar[nombre]) modelosRenderizar[nombre]=f; });
  const grid=document.createElement("div"); grid.className="grid";
  Object.keys(modelosRenderizar).sort().forEach(modelo=>{
    const card=document.createElement("div"); card.className="card";
    const ejemplo=modelosRenderizar[modelo];
    const versiones = modelosRaw.filter(f => f[indexes.COL_MODELO] === modelo);
    const imgUrl = ejemplo[indexes.COL_IMG_VEHICULO];
    const img=document.createElement("img"); img.src=convertirAGoogleThumbnail(imgUrl); img.alt=`Modelo ${modelo}`; card.appendChild(img);
    const overlay=document.createElement("div"); overlay.className="overlay";
    const anos = ejemplo[indexes.COL_AÑOS] || '';
    const encendido = ejemplo[indexes.COL_TIPO_ENCENDIDO] || '';
    card.onclick=()=>{
      if(versiones.length===1) mostrarDetalleModal(ejemplo, datosOriginales[0]);
      else mostrarVersiones(versiones, categoria, marca, modelo);
    };
    if(versiones.length === 1) {
        overlay.innerHTML = `<div>${modelo}</div>
                             ${anos ? `<div style="font-size:0.8em; opacity:0.8; font-weight:normal;">${anos}</div>` : ''}
                             ${encendido ? `<div style="font-size:0.8em; opacity:0.8; font-weight:normal;">${encendido}</div>` : ''}`;
    } else {
        overlay.innerHTML = `<div>${modelo}</div>
                             <div style="font-size:0.8em; opacity:0.8; font-weight:normal;">(${versiones.length} cortes)</div>`;
    }
    card.appendChild(overlay);
    grid.appendChild(card);
  });
  cont.appendChild(grid);
}

function mostrarVersiones(filas, categoria, marca, modelo){
  estado.nivel="versiones"; estado.modelo=modelo;
  document.getElementById("searchInput").value = "";
  const cont=document.getElementById("contenido");
  cont.innerHTML=`<span class="backBtn" onclick="mostrarModelos('${categoria}','${marca}')">${backSvg} Volver a Modelos (${modelo})</span><h4>Cortes/Años de ${modelo}</h4>`;
  const grid=document.createElement("div"); grid.className="grid";
  const header = datosOriginales[0];
  const indexes = getHeaderIndexes(header);
  filas.forEach(f=>{
    const card=document.createElement("div"); card.className="card";
    const imgUrl = f[indexes.COL_IMG_VEHICULO];
    const img=document.createElement("img"); img.src=convertirAGoogleThumbnail(imgUrl); img.alt=`Corte ${f[indexes.COL_AÑOS]}`; card.appendChild(img);
    const overlay=document.createElement("div"); overlay.className="overlay";
    const anosRaw = (f[indexes.COL_AÑOS] || '').trim();
    const encendido = (f[indexes.COL_TIPO_ENCENDIDO] || '').trim();
    let mainTitle = anosRaw || modelo;
    overlay.innerHTML = `<div style="font-weight:bold;">${mainTitle}</div>
                         ${encendido ? `<div style="font-size:0.8em; opacity:0.8;">${encendido}</div>` : ''}`;
    card.appendChild(overlay);
    card.onclick=()=>mostrarDetalleModal(f, header);
    grid.appendChild(card);
  });
  cont.appendChild(grid);
}

// --- INICIALIZACIÓN Y LÓGICA DEL MENÚ ---
let deferredPrompt;
window.addEventListener('beforeinstallprompt', (e) => {
    e.preventDefault();
    deferredPrompt = e;
    const addToHomeBtn = document.getElementById('add-to-home-btn');
    if(addToHomeBtn) addToHomeBtn.style.display = 'block';
});

function initializeApp() {
    const menuBtn = document.getElementById('menu-btn');
    const dropdownMenu = document.getElementById('dropdown-menu');
    const addToHomeBtn = document.getElementById('add-to-home-btn');

    if(menuBtn) {
        menuBtn.addEventListener('click', () => { dropdownMenu.classList.toggle('show'); });
    }

    window.addEventListener('click', function(e) {
        if (menuBtn && !menuBtn.contains(e.target) && !dropdownMenu.contains(e.target)) {
            dropdownMenu.classList.remove('show');
        }
    });

    if(addToHomeBtn) {
        addToHomeBtn.style.display = deferredPrompt ? 'block' : 'none';
        addToHomeBtn.addEventListener('click', async () => {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                console.log(`User response to the install prompt: ${outcome}`);
                deferredPrompt = null;
                addToHomeBtn.style.display = 'none';
            }
        });
    }

    fetchData(RANGE_CORTES, (vals) => datosOriginales = vals, mostrarCategorias, 'contenido');
}

// --- REGISTRO DEL SERVICE WORKER Y ARRANQUE DE LA APP ---
if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
        navigator.serviceWorker.register('./service-worker.js').then(registration => {
            console.log('ServiceWorker registrado con éxito:', registration.scope);
        }).catch(err => {
            console.log('Fallo en el registro de ServiceWorker:', err);
        });
        // Iniciar la app después de que la página se haya cargado
        initializeApp();
    });
} else {
    // Si el SW no es compatible, iniciar la app de todas formas
    window.addEventListener('load', initializeApp);
}

</script>

<footer class="footer">
  Gpspedia 2025© todos los derechos reservados.
</footer>

</body>
</html>