<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>GPSpedia | Catálogo Técnico</title>
<style>
/* Estilos Globales */
body {
    font-family: Arial, sans-serif;
    margin: 0;
    padding: 0;
    background: #f4f4f4;
}
h1,h2,h3,h4 {
    margin: 10px 0;
}
.container {
    padding: 20px;
    max-width: 1240px; 
    margin: 0 auto;
}
.backBtn {
    margin-bottom: 15px;
    cursor: pointer;
    color: #007bff;
    display: inline-flex;
    align-items: center;
    font-weight: bold;
    padding: 5px 10px;
    border-radius: 5px;
    transition: background 0.2s;
}
.backBtn:hover {
    background: #e9f7ff;
}

/* --- ESTILOS DEL ENCABEZADO (Header) --- */
.header-container {
    display: flex;
    align-items: center;
    justify-content: flex-start; 
    margin-bottom: 20px;
}
.app-logo {
    max-width: 96px; 
    height: auto;
    border-radius: 8px; 
    margin-right: 15px; 
}
h1.app-title {
    text-align: left; 
    margin: 0;
    font-size: 2.2em;
    color: #333;
}

/* --- ESTILOS DEL BUSCADOR --- */
.search-container {
    margin-bottom: 30px;
    padding: 10px 0;
    /* Limitar ancho en escritorio y centrar */
    max-width: 600px; 
    margin-left: auto;
    margin-right: auto;
}
.search-container label {
    display: block;
    font-size: 1.1em;
    font-weight: bold;
    color: #555;
    margin-bottom: 8px;
}
.search-container input[type="text"] {
    width: 100%;
    padding: 12px 15px;
    border: 1px solid #ccc;
    border-radius: 8px;
    box-sizing: border-box;
    font-size: 1em;
    transition: border-color 0.3s, box-shadow 0.3s;
}
.search-container input[type="text"]:focus {
    border-color: #007bff;
    box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.25);
    outline: none;
}


/* Estilos de la Cuadrícula */
.grid {
    display: grid;
    gap: 20px;
    /* CLAVE PARA CENTRADO GLOBAL: Usamos auto-fit y ancho fijo (140px) 
       para que justify-content: center centre el conjunto de columnas. */
    grid-template-columns: repeat(auto-fit, 140px); 
    justify-content: center; /* Centra el conjunto completo de tarjetas */
    max-width: 1200px; 
    margin: 0 auto; 
}

/* Estilos de la Tarjeta (Card) - Centrado CLAVE */
.card {
    position: relative;
    background: #fff;
    border-radius: 12px; 
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    cursor: pointer;
    padding: 0; 
    overflow: hidden; 
    transition: transform 0.3s ease, box-shadow 0.3s ease;
    
    /* Propiedades para asegurar que la tarjeta no exceda el ancho de la columna */
    width: 100%; 
    max-width: 140px; 
    justify-self: center; 
}

.card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
}

/* Imagen dentro de la Tarjeta */
.card img {
    width: 100%;
    height: 120px; 
    object-fit: contain; 
    display: block; 
    border-radius: 0; 
}

/* Overlay - CLAVE */
.overlay {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    background: linear-gradient(to top, rgba(0, 0, 0, 0.9) 0%, rgba(0, 0, 0, 0) 100%); 
    color: #fff;
    padding: 10px 8px 8px 8px; 
    font-size: 0.9em;
    line-height: 1.3;
    font-weight: bold;
    border-radius: 0;
    z-index: 10;
}

/* Modal */
#modalDetalle{
    display:none; 
    position:fixed;
    top:0;
    left:0;
    width:100%;
    height:100%;
    overflow:auto;
    background:rgba(0,0,0,0.8);
    color:#000;
    z-index:999; 
}
#detalleCompleto{
    background:#fff;
    margin:50px auto;
    padding:30px;
    max-width:90%; 
    border-radius:15px; 
    box-shadow: 0 0 20px rgba(0,0,0,0.5);
    max-height: 90vh; 
    overflow-y: auto;
}
#detalleCompleto img{
    max-width:100%; 
    max-height:60vh; 
    margin-bottom:15px; 
    cursor:pointer; 
    object-fit:contain; 
    border-radius:8px; 
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}
#detalleCompleto h4 { 
    color: #007bff; 
    border-bottom: 2px solid #eee; 
    padding-bottom: 5px; 
}

/* Lightbox */
.lightbox{
    position:fixed;
    top:0;
    left:0;
    width:100%;
    height:100%;
    background:rgba(0,0,0,0.9);
    display:flex;
    align-items:center;
    justify-content:center;
    z-index:1000;
}
.lightbox img{max-width:95%; max-height:95%;}

</style>
</head>
<body>

<div class="container">
  
  <!-- CONTENEDOR DEL ENCABEZADO -->
  <div class="header-container">
      <!-- LOGO DE LA APLICACIÓN -->
      <img src="https://drive.google.com/thumbnail?id=1NxBx-W_gWmcq3fA9zog6Dpe-WXpH_2e8&sz=2048" alt="Logo de GPSpedia" class="app-logo">
      
      <!-- TÍTULO PRINCIPAL (GPSpedia) -->
      <h1 class="app-title">GPSpedia</h1>
  </div>

  <!-- CUADRO DE BÚSQUEDA -->
  <div class="search-container">
      <label for="searchInput">Buscar Corte</label>
      <input type="text" id="searchInput" placeholder="Escribe marca, modelo, año o categoría..." oninput="filtrarContenido(this.value)">
  </div>
  
  <div id="contenido"></div>
</div>

<!-- Modal Detalle -->
<div id="modalDetalle">
  <div id="detalleCompleto"></div>
</div>

<!-- Lightbox -->
<div id="lightbox" class="lightbox" style="display:none;" onclick="cerrarLightbox()">
  <img id="lightboxImg" src="">
</div>

<script>
// CONFIGURACIÓN DE LA HOJA DE CÁLCULO
const SPREADSHEET_ID = "1jEdC2NMc2a5F36xE2MJfgxMZiZFVfeDqnCdVizNGIMo"; 
const RANGE = "Cortes";
const API_KEY = "AIzaSyCooAsC52X4ccENCT6p3qh_82ErBxP47Lg";

// CLAVE CORREGIDA: Usamos el nombre exacto de la columna que devuelve el API.
const COLUMN_NAME_AÑOS = "Año (generacion)"; 

let datosOriginales=[], 
    datosFiltrados = [], 
    estado={nivel:"categorias", categoria:null, marca:null, modelo:null};

// Icono SVG para Volver
const backSvg = '<svg style="width:20px;height:20px;margin-right:5px;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"></polyline></svg>';

/**
 * Obtiene los índices de las columnas clave del encabezado.
 */
function getHeaderIndexes(header) {
    if (!header || header.length < 5) {
        console.error("Error: Encabezado de datos incompleto o no cargado.");
        // Fallback indexes: Usar índices numéricos si falla la detección de nombres (Basado en el encabezado provisto por el usuario)
        return { 
            COL_CAT: 1, 
            COL_MARCA: 3, 
            COL_MODELO: 4, 
            COL_AÑOS: 6, // Índice 6 según el encabezado provisto
            COL_IMG_VEHICULO: 2, 
            COL_IMG_PORTADA: -1, // No usado en este contexto
            COL_IMG_APERTURA: 14, 
            COL_TIPO_ENCENDIDO: 5
        };
    }
    
    // Obtenemos los índices por nombre (esta es la mejor práctica)
    const indexAños = header.indexOf(COLUMN_NAME_AÑOS);

    // DEBUGGING MANTENIDO: Si se ejecuta correctamente, indexAños será 6.
    console.log(`DEBUG: Índice de la columna ${COLUMN_NAME_AÑOS}: ${indexAños}`);

    return {
        COL_CAT: header.indexOf("Categoria"),
        COL_MARCA: header.indexOf("Marca"),
        COL_MODELO: header.indexOf("Modelo"),
        // CLAVE: Usamos el índice encontrado, o si no se encuentra (-1), usamos el 6 como fallback (según tu hoja)
        COL_AÑOS: (indexAños > -1) ? indexAños : 6, 
        COL_TIPO_ENCENDIDO: header.indexOf("Tipo de encendido"), 
        
        COL_IMG_VEHICULO: header.indexOf("Imagen del vehiculo"), 
        COL_IMG_PORTADA: header.indexOf("Imagen de la portada"), 
        COL_IMG_APERTURA: header.indexOf("Imagen de la apertura"), 
    };
}


// Convertir enlaces Google Drive a miniaturas (tamaño mediano)
function convertirAGoogleThumbnail(url){
  if(!url) return "https://placehold.co/280x200/cccccc/333333?text=Sin+Imagen"; 
  let idMatch = url.match(/id=([a-zA-Z0-9_-]+)/) || url.match(/\/d\/([a-zA-Z0-9_-]+)/);
  if(idMatch) return `https://drive.google.com/thumbnail?sz=w1000&id=${idMatch[1]}`;
  return url;
}

// Lightbox
function mostrarLightbox(src){
  let idMatch = src.match(/id=([a-zA-Z0-9_-]+)/) || src.match(/\/d\/([a-zA-Z0-9_-]+)/);
  let finalUrl = src; 

  if(idMatch && idMatch[1]){
      finalUrl = `https://drive.google.com/thumbnail?id=${idMatch[1]}&sz=w2000`; 
  } else {
       console.warn("Advertencia: No se pudo encontrar un ID de Google Drive válido para el Lightbox. Usando URL original.");
  }
  
  document.getElementById("lightboxImg").src = finalUrl;
  document.getElementById("lightbox").style.display="flex";
}
function cerrarLightbox(){document.getElementById("lightbox").style.display="none";}

// Función mejorada para extraer el ID de video de varios formatos de YouTube
function extractYouTubeId(url) {
    if (!url) return null;
    let videoId = null;
    try {
        const urlObj = new URL(url);

        if (urlObj.hostname.includes('youtube.com') && urlObj.searchParams.get('v')) {
            videoId = urlObj.searchParams.get('v');
        } 
        else if (urlObj.hostname.includes('youtu.be') && urlObj.pathname.length > 1) {
            videoId = urlObj.pathname.substring(1);
        }
        else if (urlObj.pathname.includes('/embed/') && urlObj.pathname.length > 7) {
            const parts = urlObj.pathname.split('/embed/');
            if (parts.length > 1) {
                videoId = parts[1].split(/[?&]/)[0];
            }
        }
    } catch (e) { 
        return null;
    }
    return videoId;
}

// Modal detalle
function mostrarDetalleModal(fila, header){
  const modal = document.getElementById("modalDetalle");
  const cont = document.getElementById("detalleCompleto"); 
  cont.innerHTML = ""; 
  const indexes = getHeaderIndexes(header);

  // 1. Crear el botón de cerrar
  const closeBtn = document.createElement("button");
  closeBtn.textContent = "Cerrar Detalle";
  closeBtn.onclick = cerrarModal;
  closeBtn.className = "backBtn";
  closeBtn.style.color = "white";
  closeBtn.style.background = "#dc3545"; 
  closeBtn.style.border = "none";
  closeBtn.style.marginBottom = "20px";
  cont.appendChild(closeBtn); 

  
  const title = document.createElement("h2");
  const modeloNombre = fila[indexes.COL_MODELO] || 'Modelo Desconocido';
  // Obtener Años directamente usando el índice
  const anosNombre = fila[indexes.COL_AÑOS] || ''; 
  title.textContent = `Detalle de ${modeloNombre} ${anosNombre ? `(${anosNombre})` : ''}`;
  title.style.color = "#007bff";
  title.style.borderBottom = "3px solid #007bff";
  title.style.paddingBottom = "10px";
  cont.appendChild(title);

  // Campos a mostrar en el detalle
  const campos = [
    {label:"Nota Importante", key:"Nota Importante", isTitle: true},
    {label:"Modelo", key:"Imagen del vehiculo"},
    {label:"Tipo de Corte", key:"Tipo de corte"},
    {label:"Descripción", key:"Descripcion del corte"},
    {label:"Imagen", key:"Imagen del Corte"},
    {label:"Segunda Opción", key:"Tipo de corte 2"},
    {label:"Segunda Descripción:", key:"Descripción del Segundo corte"},
    {label:"Imagen del Segundo Corte", key:"Imagen de corte 2"},
    {label:"Apertura", key:"Apertura"},
    {label:"Imagen de la Apertura", key:"Imagen de la apertura"},
    {label:"Alimentación", key:"Cables de Alimentacion"},
    {label:"Imagen de Alimentación", key:"Imagen de los cables de alimentacion"},
    {label:"Imagen de la portada (Alternativa)", key:"Imagen de la portada"}
  ];

  campos.forEach(c => {
    let index = header.indexOf(c.key);
    if(index > -1){
        let valor = fila[index];
        if(valor){
            if(c.key.includes("Imagen")){
                const h=document.createElement("h4"); h.textContent=c.label; cont.appendChild(h);
                const img=document.createElement("img"); 
                img.src=convertirAGoogleThumbnail(valor); 
                img.alt=c.label;
                img.onclick=()=>mostrarLightbox(valor); 
                cont.appendChild(img);
            } else {
                const p=document.createElement("p"); 
                if(c.isTitle){
                    p.innerHTML = `<strong style="color:red;">${c.label}:</strong> <span style="color:#cc0000; font-weight: bold;">${valor}</span>`;
                } else {
                    p.innerHTML=`<strong>${c.label}:</strong> ${valor}`; 
                }
                cont.appendChild(p);
            }
        }
    }
  });

  // Video embed YouTube
  const videoUrlRaw = fila[header.indexOf("Como desarmar los plasticos")] || "";
  const videoId = extractYouTubeId(videoUrlRaw.trim());

  if (videoId) {
      const h=document.createElement("h4"); h.textContent="Video Guía de Desarme"; cont.appendChild(h);
      const iframeContainer = document.createElement("div");
      iframeContainer.style.position = "relative";
      iframeContainer.style.paddingBottom = "56.25%"; 
      iframeContainer.style.height = "0";
      iframeContainer.style.marginBottom = "20px";

      const iframe=document.createElement("iframe");
      iframe.src = `https://www.youtube.com/embed/${videoId}`;
      iframe.title = "Video Guía";
      iframe.allow = "accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture";
      iframe.allowFullscreen = true;
      iframe.style.border = "none";
      iframe.style.position = "absolute";
      iframe.style.top = "0";
      iframe.style.left = "0";
      iframe.style.width = "100%";
      iframe.style.height = "100%";
      
      iframeContainer.appendChild(iframe);
      cont.appendChild(iframeContainer);
  }

  // 2. Volver a añadir el botón de cerrar al final
  const closeBtnBottom = closeBtn.cloneNode(true);
  closeBtnBottom.onclick = cerrarModal;
  cont.appendChild(closeBtnBottom);

  modal.style.display="flex";
}

function cerrarModal(){ document.getElementById("modalDetalle").style.display="none"; }

/**
 * Lógica de Filtrado de Contenido
 */
function filtrarContenido(textoBusqueda){
    const busqueda = textoBusqueda.toLowerCase().trim();
    
    if (busqueda.length === 0) {
        datosFiltrados = [];
        estado.nivel = "categorias";
        mostrarCategorias();
        return;
    }

    const header = datosOriginales[0];
    const indexes = getHeaderIndexes(header);
    
    const dataToFilter = datosOriginales.slice(1);
    const palabrasBusqueda = busqueda.split(' ').filter(p => p.length > 0);

    datosFiltrados = dataToFilter.filter(fila => {
        // Concatenar todos los campos relevantes para la búsqueda
        const filaTexto = [
            fila[indexes.COL_CAT],
            fila[indexes.COL_MARCA],
            fila[indexes.COL_MODELO],
            fila[indexes.COL_AÑOS], 
            fila[indexes.COL_TIPO_ENCENDIDO] 
        ].map(s => (s || '').toLowerCase()).join(' ');

        return palabrasBusqueda.every(palabra => filaTexto.includes(palabra));
    });

    if(datosFiltrados.length > 0){
        // Corregido: Llamar a la función con el nombre unificado
        mostrarResultadosBusquedaMarca(busqueda);
    } else {
        document.getElementById("contenido").innerHTML = `<p style="text-align:center; padding: 20px;">No se encontraron resultados para "${busqueda}".</p>`;
    }

    estado.nivel = "busqueda";
    estado.categoria = null;
    estado.marca = null;
    estado.modelo = null;
}

// ----------------------------------------------------
// FUNCIONES DE DISPLAY JERÁRQUICO PARA RESULTADOS DE BÚSQUEDA
// ----------------------------------------------------

/**
 * Muestra las Marcas únicas encontradas en la búsqueda. (Nivel 1: Marca)
 * Se renombró de mostrarResultsBusquedaMarca a mostrarResultadosBusquedaMarca
 */
function mostrarResultadosBusquedaMarca(busquedaTexto){
    const cont = document.getElementById("contenido");
    const header = datosOriginales[0];
    const indexes = getHeaderIndexes(header);

    // Si solo hay un resultado, mostramos el detalle directamente
    if (datosFiltrados.length === 1) {
        // Usar el valor directo de COL_AÑOS
        const anosRaw = (datosFiltrados[0][indexes.COL_AÑOS] || '').trim();
        mostrarDetalleModal(datosFiltrados[0], header);
        cont.innerHTML = `<h4>Resultado Exacto Encontrado</h4><p>Abriendo detalle de ${datosFiltrados[0][indexes.COL_MODELO]} ${anosRaw ? `(${anosRaw})` : ''}.</p>`;
        return; 
    }

    cont.innerHTML = `<h4>Resultados de búsqueda para: "${busquedaTexto}"</h4>`;

    const marcasUnicas = [...new Set(datosFiltrados.map(f => f[indexes.COL_MARCA]))].filter(m => m);
    const grid = document.createElement("div"); grid.className = "grid";
    
    marcasUnicas.forEach(marca => {
        const ejemplo = datosFiltrados.find(f => 
            f[indexes.COL_MARCA] === marca && 
            f[indexes.COL_IMG_VEHICULO] 
        ) || datosFiltrados.find(f => f[indexes.COL_MARCA] === marca); 
        
        const card=document.createElement("div"); card.className="card";
        
        card.onclick=()=>mostrarResultadosBusquedaModelo(busquedaTexto, marca);
        
        // Imagen del vehículo/corte
        const imgUrl = ejemplo ? ejemplo[indexes.COL_IMG_VEHICULO] : '';
        const img=document.createElement("img"); 
        img.src=convertirAGoogleThumbnail(imgUrl); 
        img.alt=`Marca ${marca}`;
        card.appendChild(img);
        
        const overlay=document.createElement("div"); overlay.className="overlay";
        overlay.innerHTML = marca;
        card.appendChild(overlay);

        grid.appendChild(card);
    });

    cont.appendChild(grid);
}

/**
 * Muestra los Modelos únicos dentro de una Marca filtrada. (Nivel 2: Modelo)
 */
function mostrarResultadosBusquedaModelo(busquedaTexto, marcaFiltro){
    const header = datosOriginales[0];
    const indexes = getHeaderIndexes(header);

    const cont = document.getElementById("contenido");
    // Corregido: Llamar a la función con el nombre unificado en el botón de volver
    cont.innerHTML = `<span class="backBtn" onclick="mostrarResultadosBusquedaMarca('${busquedaTexto}')">${backSvg} Volver a Marcas</span>
                      <h4>Modelos de ${marcaFiltro} (Búsqueda: "${busquedaTexto}")</h4>`;

    const modelosRaw = datosFiltrados.filter(f => f[indexes.COL_MARCA] === marcaFiltro);
    
    // Solo necesitamos los modelos ÚNICOS para la tarjeta de este nivel
    const modelosRenderizar = {};
    modelosRaw.forEach(f => {
        const nombre = f[indexes.COL_MODELO];
        if (!modelosRenderizar[nombre]) {
            modelosRenderizar[nombre] = f;
        }
    });

    const grid=document.createElement("div"); grid.className = "grid";

    Object.keys(modelosRenderizar).forEach(modelo => {
        const ejemplo = modelosRenderizar[modelo];
        const versiones = modelosRaw.filter(f => f[indexes.COL_MODELO] === modelo); // Filtrar todas las filas del modelo
        
        const card=document.createElement("div"); card.className="card";
        
        card.onclick=()=>{
            // Si solo hay una fila para este modelo, mostramos detalle.
            if(versiones.length===1){
                mostrarDetalleModal(ejemplo, header);
            } else {
                // Si hay varias filas (distintos años o tipos de encendido) vamos al siguiente nivel
                // Corregido: Llamar a la función con el nombre unificado
                mostrarResultadosBusquedaVersion(busquedaTexto, marcaFiltro, modelo); // Se usa modelo como filtro secundario
            }
        };

        // Imagen del vehículo/corte (Imagen del vehiculo)
        const imgUrl = ejemplo[indexes.COL_IMG_VEHICULO];
        const img=document.createElement("img"); 
        img.src=convertirAGoogleThumbnail(imgUrl);
        img.alt=`Modelo ${modelo}`;
        card.appendChild(img);

        const overlay=document.createElement("div"); overlay.className="overlay";
        // Obtener Años directamente usando el índice
        const anos = ejemplo[indexes.COL_AÑOS] || ''; 
        const encendido = ejemplo[indexes.COL_TIPO_ENCENDIDO] || '';

        // Si es un modelo con una sola versión, mostramos más detalle en la tarjeta
        if(versiones.length === 1) {
            overlay.innerHTML = `<div>${modelo}</div>
                                 ${anos ? `<div style="font-size:0.8em; opacity:0.8; font-weight:normal;">${anos}</div>` : ''}
                                 ${encendido ? `<div style="font-size:0.8em; opacity:0.8; font-weight:normal;">${encendido}</div>` : ''}`;
        } else {
            overlay.innerHTML = `<div>${modelo}</div>
                                 <div style="font-size:0.8em; opacity:0.8; font-weight:normal;">(${versiones.length} cortes)</div>`;
        }

        card.appendChild(overlay);

        grid.appendChild(card);
    });
    cont.appendChild(grid);
}

/**
 * Muestra Versiones individuales (Años/Tipo de encendido) dentro de un Modelo filtrado. (Nivel 3: Detalle)
 * Se renombró de mostrarResultsBusquedaVersion a mostrarResultadosBusquedaVersion
 */
function mostrarResultadosBusquedaVersion(busquedaTexto, marcaFiltro, modeloFiltro){
    const header = datosOriginales[0];
    const indexes = getHeaderIndexes(header);

    const cont = document.getElementById("contenido");
    cont.innerHTML = `<span class="backBtn" onclick="mostrarResultadosBusquedaModelo('${busquedaTexto}', '${marcaFiltro}')">${backSvg} Volver a Modelos (${modeloFiltro})</span>
                      <h4>Cortes/Años de ${modeloFiltro} (Búsqueda: "${busquedaTexto}")</h4>`;
    
    // Filtramos las filas que coinciden con el modelo
    const filasDetalle = datosFiltrados.filter(f => f[indexes.COL_MARCA] === marcaFiltro && f[indexes.COL_MODELO] === modeloFiltro);
    const grid=document.createElement("div"); grid.className="grid";

    filasDetalle.forEach(f => {
        const card=document.createElement("div"); card.className="card";
        
        // Imagen del vehículo/corte (Imagen del vehiculo)
        const imgUrl = f[indexes.COL_IMG_VEHICULO];
        const img=document.createElement("img"); 
        img.src=convertirAGoogleThumbnail(imgUrl);
        // Usar el valor directo de COL_AÑOS para el alt
        img.alt=`Corte ${f[indexes.COL_AÑOS]}`; 
        card.appendChild(img);
        
        const overlay=document.createElement("div"); overlay.className="overlay";
        
        // --- LÓGICA CLAVE: Usar Años y Tipo de Encendido ---
        const anosRaw = (f[indexes.COL_AÑOS] || '').trim(); // Se toma el valor directo
        const encendido = (f[indexes.COL_TIPO_ENCENDIDO] || '').trim(); 

        let mainTitle = anosRaw || modeloFiltro; // Si por alguna razón está vacío, usa el nombre del modelo.

        // Mostrar Título (Año) y Tipo de Encendido
        overlay.innerHTML = `<div style="font-weight:bold;">${mainTitle}</div>
                             ${encendido ? `<div style="font-size:0.8em; opacity:0.8;">${encendido}</div>` : ''}`;
        // --- FIN LÓGICA CLAVE ---

        card.appendChild(overlay);
        
        card.onclick=()=>mostrarDetalleModal(f, header);
        grid.appendChild(card);
    });

    cont.appendChild(grid);
}


// ----------------------------------------------------
// FUNCIONES DE DISPLAY JERÁRQUICO PARA NAVEGACIÓN ESTÁNDAR (NO BÚSQUEDA)
// ----------------------------------------------------

// Mostrar Categorías (Usando datosOriginales)
function mostrarCategorias(){
  if(document.getElementById("searchInput").value.trim().length > 0) return;

  estado.nivel="categorias"; estado.categoria=null;
  const cont=document.getElementById("contenido"); cont.innerHTML="<h4>Categorías</h4>";
  
  if (datosOriginales.length <= 1) {
    document.getElementById("contenido").innerHTML = '<p style="color:red; font-size:1.2em;">Advertencia: La hoja de cálculo está vacía o el rango es incorrecto.</p>';
    return;
  }
  
  const header = datosOriginales[0];
  const indexes = getHeaderIndexes(header);

  const categorias = [...new Set(datosOriginales.slice(1).map(f=>f[indexes.COL_CAT]))].filter(c => c);
  
  const grid = document.createElement("div"); grid.className="grid";

  categorias.forEach(cat=>{
    // CLAVE: IMAGEN DEL VEHÍCULO: Usamos la imagen de vehiculo del primer ejemplo de esa categoría.
    const ejemplo = datosOriginales.slice(1).find(f=>f[indexes.COL_CAT]===cat);
    const card=document.createElement("div"); card.className="card";
    card.onclick=()=>mostrarMarcas(cat);
    
    // Imagen del vehículo/corte
    const imgUrl = ejemplo ? ejemplo[indexes.COL_IMG_VEHICULO] : '';
    const img=document.createElement("img"); 
    img.src=convertirAGoogleThumbnail(imgUrl); 
    img.alt=`Imagen de la categoría ${cat}`;
    card.appendChild(img); 
    
    const overlay=document.createElement("div"); overlay.className="overlay";
    overlay.innerHTML = cat;
    card.appendChild(overlay);

    grid.appendChild(card);
  });
  cont.appendChild(grid);
}

// Mostrar Marcas (Usando datosOriginales)
function mostrarMarcas(categoria){
  document.getElementById("searchInput").value = ""; 
  estado.nivel="marcas"; estado.categoria=categoria;
  const cont=document.getElementById("contenido"); 
  cont.innerHTML=`<span class="backBtn" onclick="mostrarCategorias()">${backSvg} Volver a Categorías</span><h4>Marcas de ${categoria}</h4>`;
  
  const header = datosOriginales[0];
  const indexes = getHeaderIndexes(header);

  const marcas = [...new Set(datosOriginales.slice(1).filter(f=>f[indexes.COL_CAT]===categoria).map(f=>f[indexes.COL_MARCA]))].filter(m => m);
  const grid = document.createElement("div"); grid.className="grid";
  
  marcas.forEach(m=>{
    // CLAVE: IMAGEN DEL VEHÍCULO: Usamos la imagen de vehiculo del primer ejemplo de esa marca.
    const ejemplo = datosOriginales.slice(1).find(f=>f[indexes.COL_CAT]===categoria && f[indexes.COL_MARCA]===m);
    const card=document.createElement("div"); card.className="card";
    card.onclick=()=>mostrarModelos(categoria,m);
    
    // Imagen del vehículo/corte
    const imgUrl = ejemplo ? ejemplo[indexes.COL_IMG_VEHICULO] : '';
    const img=document.createElement("img"); 
    img.src=convertirAGoogleThumbnail(imgUrl);
    img.alt=`Imagen de la marca ${m}`;
    card.appendChild(img);
    
    const overlay=document.createElement("div"); overlay.className="overlay";
    overlay.innerHTML = m;
    card.appendChild(overlay);
    
    grid.appendChild(card);
  });
  cont.appendChild(grid);
}

// Mostrar Modelos agrupados (Usando datosOriginales)
function mostrarModelos(categoria, marca){
  estado.nivel="modelos"; estado.marca=marca;
  document.getElementById("searchInput").value = ""; 
  const cont=document.getElementById("contenido"); 
  cont.innerHTML=`<span class="backBtn" onclick="mostrarMarcas('${categoria}')">${backSvg} Volver a Marcas</span><h4>Modelos de ${marca}</h4>`;
  
  const header = datosOriginales[0];
  const indexes = getHeaderIndexes(header);
  
  const modelosRaw = datosOriginales.slice(1).filter(f=>f[indexes.COL_CAT]===categoria && f[indexes.COL_MARCA]===marca);
  
  const modelosRenderizar = {};
  // Agrupar solo por Modelo para la visualización de la tarjeta en este nivel
  modelosRaw.forEach(f=>{
    const nombre = f[indexes.COL_MODELO];
    if(!modelosRenderizar[nombre]) modelosRenderizar[nombre]=f;
  });

  const grid=document.createElement("div"); grid.className="grid";

  Object.keys(modelosRenderizar).forEach(modelo=>{
    const card=document.createElement("div"); card.className="card";
    const ejemplo=modelosRenderizar[modelo];
    
    // Todas las filas para este modelo (posiblemente con distintos años/encendidos)
    const versiones = modelosRaw.filter(f => f[indexes.COL_MODELO] === modelo); 
    
    // Imagen del vehículo/corte (Imagen del vehiculo)
    const imgUrl = ejemplo[indexes.COL_IMG_VEHICULO];
    const img=document.createElement("img"); 
    img.src=convertirAGoogleThumbnail(imgUrl);
    img.alt=`Modelo ${modelo}`;
    card.appendChild(img);

    const overlay=document.createElement("div"); overlay.className="overlay";
    // Obtener Años directamente usando el índice
    const anos = ejemplo[indexes.COL_AÑOS] || ''; 
    const encendido = ejemplo[indexes.COL_TIPO_ENCENDIDO] || '';

    card.onclick=()=>{
      if(versiones.length===1){
        mostrarDetalleModal(ejemplo, datosOriginales[0]);
      } else {
        mostrarVersiones(versiones, categoria, marca, modelo);
      }
    };
    
    // Si es un modelo con una sola versión, mostramos más detalle en la tarjeta
    if(versiones.length === 1) {
        overlay.innerHTML = `<div>${modelo}</div>
                             ${anos ? `<div style="font-size:0.8em; opacity:0.8; font-weight:normal;">${anos}</div>` : ''}
                             ${encendido ? `<div style="font-size:0.8em; opacity:0.8; font-weight:normal;">${encendido}</div>` : ''}`;
    } else {
        overlay.innerHTML = `<div>${modelo}</div>
                             <div style="font-size:0.8em; opacity:0.8; font-weight:normal;">(${versiones.length} cortes)</div>`;
    }

    card.appendChild(overlay);
    grid.appendChild(card);
  });
  cont.appendChild(grid);
}


// Mostrar versiones del modelo como tarjetas separadas (Usando datosOriginales)
function mostrarVersiones(filas, categoria, marca, modelo){
  estado.nivel="versiones"; 
  estado.modelo=modelo;
  document.getElementById("searchInput").value = ""; 
  const cont=document.getElementById("contenido"); 
  cont.innerHTML=`<span class="backBtn" onclick="mostrarModelos('${categoria}','${marca}')">${backSvg} Volver a Modelos (${modelo})</span><h4>Cortes/Años de ${modelo}</h4>`;
  const grid=document.createElement("div"); grid.className="grid";
  const header = datosOriginales[0];
  const indexes = getHeaderIndexes(header);

  filas.forEach(f=>{
    const card=document.createElement("div"); card.className="card";
    
    // Imagen del vehículo/corte (Imagen del vehiculo)
    const imgUrl = f[indexes.COL_IMG_VEHICULO];
    const img=document.createElement("img"); 
    img.src=convertirAGoogleThumbnail(imgUrl);
    // Usar el valor directo de COL_AÑOS para el alt
    img.alt=`Corte ${f[indexes.COL_AÑOS]}`; 
    card.appendChild(img);
    
    const overlay=document.createElement("div"); overlay.className="overlay";
    
    // --- LÓGICA CLAVE: Usar Años y Tipo de Encendido ---
    const anosRaw = (f[indexes.COL_AÑOS] || '').trim(); // Se toma el valor directo
    const encendido = (f[indexes.COL_TIPO_ENCENDIDO] || '').trim(); 

    let mainTitle = anosRaw || modelo; // Si por alguna razón está vacío, usa el nombre del modelo.

    // Mostrar Título (Año) y Tipo de Encendido
    overlay.innerHTML = `<div style="font-weight:bold;">${mainTitle}</div>
                         ${encendido ? `<div style="font-size:0.8em; opacity:0.8;">${encendido}</div>` : ''}`;
    // --- FIN LÓGICA CLAVE ---

    card.appendChild(overlay);
    
    card.onclick=()=>mostrarDetalleModal(f, header);
    grid.appendChild(card);
  });

  cont.appendChild(grid);
}

// Obtener datos desde Google Sheets
fetch(`https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${RANGE}?key=${API_KEY}`)
.then(res=>{
    if (!res.ok) {
        throw new Error(`Error ${res.status}: Fallo al cargar la hoja de cálculo. (Código: ${res.status})`);
    }
    return res.json();
})
.then(data=>{
  datosOriginales = data.values || [];
  if (datosOriginales.length === 0) {
    document.getElementById("contenido").innerHTML = '<p style="color:red; font-size:1.2em;">Advertencia: La hoja de cálculo está vacía o el rango es incorrecto.</p>';
    return;
  }
  
  // *** DEBUGGING MANTENIDO: Muestra el encabezado exacto que devuelve el API ***
  console.log("DEBUG: Encabezado completo de la hoja:", datosOriginales[0]);
  
  mostrarCategorias();
})
.catch(err=>{
  console.error("Error al cargar datos:", err);
  document.getElementById("contenido").innerHTML = `<p style="color:red; font-size:1.2em;">Error al cargar el catálogo: ${err.message}. Revise su SPREADSHEET_ID y API_KEY.</p>`;
});
</script>
</body>
</html>

