<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>GPSpedia | Gestión de Cuentas</title>
<link rel="icon" href="https://drive.google.com/thumbnail?id=1NxBx-W_gWmcq3fA9zog6Dpe-WXpH_2e8&sz=w256">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
<style>
    /* --- Estilos Reutilizados de index.html --- */
    body { font-family: Arial, sans-serif; margin: 0; padding: 0; background: #f4f4f4; display: flex; flex-direction: column; min-height: 100vh; }
    .container { padding: 20px; max-width: 1240px; margin: 0 auto; width: 100%; box-sizing: border-box; flex: 1 0 auto; }
    .header-container { display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; margin-bottom: 20px; gap: 15px; }
    .header-branding { display: flex; align-items: center; gap: 15px; }
    .app-logo { max-width: 96px; height: auto; border-radius: 8px; }
    h1.app-title { text-align: left; margin: 0; font-size: 2.2em; color: #333; }
    .footer { text-align: center; padding: 20px 0; margin-top: 40px; background-color: #333; color: #fff; font-size: 0.9em; width: 100%; }
    .backBtn { display: inline-flex; align-items: center; font-weight: bold; padding: 8px 15px; border-radius: 8px; cursor: pointer; color: #fff; background-color: #007bff; text-decoration: none; border: none; margin-bottom: 20px;}
    .backBtn svg { margin-right: 8px; }

    /* --- Estilos Específicos para users.html --- */
    #user-management-section { background: #fff; padding: 30px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
    #user-list-container { margin-top: 20px; }
    .access-denied { text-align: center; padding: 40px; color: #777; }
    .user-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    .user-table th, .user-table td { border: 1px solid #ddd; padding: 12px; text-align: left; }
    .user-table th { background-color: #f2f2f2; }
    .user-table tr:nth-child(even) { background-color: #f9f9f9; }
    .user-table tr:hover { background-color: #f1f1f1; }
    .action-btn { background: none; border: none; cursor: pointer; padding: 5px; }
    .action-btn.edit { color: #007bff; }
    .action-btn.delete { color: #dc3545; }
    .create-user-btn { display: inline-flex; align-items: center; font-weight: bold; padding: 10px 18px; border-radius: 8px; cursor: pointer; color: #fff; background-color: #28a745; text-decoration: none; border: none; margin-bottom: 20px; }
    .create-user-btn i { margin-right: 8px; }

    /* --- Estilos para los Modales --- */
    .modal { position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; }
    .modal-content { background-color: #fefefe; margin: auto; padding: 30px; border: 1px solid #888; width: 80%; max-width: 500px; border-radius: 12px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
    .modal-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; padding-bottom: 15px; margin-bottom: 20px; }
    .modal-header h2 { margin: 0; }
    .close-btn { color: #aaa; font-size: 28px; font-weight: bold; cursor: pointer; }
    .close-btn:hover, .close-btn:focus { color: black; text-decoration: none; }
    .form-group { margin-bottom: 15px; }
    .form-group label { display: block; margin-bottom: 5px; font-weight: bold; }
    .form-group input, .form-group select { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
    .form-submit-btn { background-color: #007bff; color: white; padding: 12px 20px; border: none; border-radius: 8px; cursor: pointer; font-size: 1em; width: 100%; }

    /* --- Media Queries para Responsividad --- */
    @media screen and (max-width: 768px) {
        .user-table thead { display: none; }
        .user-table, .user-table tbody, .user-table tr, .user-table td { display: block; width: 100%; }
        .user-table tr { margin-bottom: 15px; border: 1px solid #ddd; border-radius: 8px; overflow: hidden; }
        .user-table td { text-align: right; padding-left: 50%; position: relative; border: none; border-bottom: 1px solid #eee; }
        .user-table td:before { content: attr(data-label); position: absolute; left: 10px; width: calc(50% - 20px); padding-right: 10px; white-space: nowrap; text-align: left; font-weight: bold; }
        .user-table td:last-child { border-bottom: 0; }
        .action-btn { font-size: 1.2em; padding: 8px; }
    }
</style>
</head>
<body>

<div class="container">
    <div class="header-container">
        <div class="header-branding">
            <img src="https://drive.google.com/thumbnail?id=1NxBx-W_gWmcq3fA9zog6Dpe-WXpH_2e8&sz=2048" alt="Logo de GPSpedia" class="app-logo">
            <h1 class="app-title">GPSpedia</h1>
        </div>
        <div id="header-controls" style="display: flex; align-items: center; gap: 15px;">
            <span id="welcome-message" style="color: #333; font-weight: bold;"></span>
        </div>
    </div>

    <main id="user-management-section">
        <a href="index.html" class="backBtn">
            <svg style="width:20px;height:20px;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"></polyline></svg>
            Volver al Catálogo
        </a>
        <h2 id="main-title">Gestión de Cuentas</h2>
        <div id="user-content-container">
            <p>Cargando información...</p>
        </div>
    </main>
</div>

<footer class="footer">
  Gpspedia 2025© todos los derechos reservados.
</footer>

<!-- MODALES -->
<div id="user-form-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="modal-title">Crear Nuevo Usuario</h2>
            <span class="close-btn" onclick="closeModal('user-form-modal')">&times;</span>
        </div>
        <form id="user-form" onsubmit="handleUserFormSubmit(event)">
            <input type="hidden" id="form-action" value="createUser">
            <input type="hidden" id="original-username" value="">
            <div class="form-group">
                <label for="nombre">Nombre Completo</label>
                <input type="text" id="nombre" required>
            </div>
            <div class="form-group">
                <label for="nombre-usuario">Nombre de Usuario</label>
                <input type="text" id="nombre-usuario" required>
            </div>
            <div class="form-group">
                <label for="privilegios">Rango</label>
                <select id="privilegios" required></select>
            </div>
             <div class="form-group">
                <label for="telefono">Teléfono</label>
                <input type="tel" id="telefono">
            </div>
            <div class="form-group">
                <label for="correo">Correo Electrónico</label>
                <input type="email" id="correo">
            </div>
            <div class="form-group">
                <label for="password">Contraseña</label>
                <input type="password" id="password" minlength="8">
            </div>
            <button type="submit" class="form-submit-btn">Guardar</button>
        </form>
    </div>
</div>

<div id="toast-notification" class="toast-notification"></div>

<script>
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycby1PgmBQ7XZquug9FWQhNxyhYHlK02tI4vj4gsBoWiXy1igAMuVe_9IYrsuzmIShiFh3Q/exec";
let allUsersData = [];
let currentUser = null;

document.addEventListener('DOMContentLoaded', async () => {
    const sessionData = localStorage.getItem('gpsepedia_session');
    if (!sessionData) {
        localStorage.setItem('formSubmissionSuccess', 'Tu sesión ha expirado, por favor inicia sesión de nuevo.');
        window.location.href = 'index.html';
        return;
    }

    currentUser = JSON.parse(sessionData).user;
    document.getElementById('welcome-message').textContent = `Sesión: ${currentUser.nombre} (${currentUser.privilegios})`;

    await loadInitialData();
});

async function loadInitialData() {
    const container = document.getElementById('user-content-container');
    container.innerHTML = '<p>Cargando datos...</p>';

    try {
        const response = await fetch(`${SCRIPT_URL}?sheet=Users`);
        if (!response.ok) throw new Error('No se pudo conectar al servidor de usuarios.');
        allUsersData = await response.json();

        const userRole = (currentUser.privilegios || '').trim();
        if (['Técnico', 'Tecnico_Exterior'].includes(userRole)) {
            document.getElementById('main-title').textContent = 'Mi Perfil';
            renderUserProfile(currentUser.nombreUsuario);
        } else if (['Supervisor', 'Gefe', 'Desarrollador'].includes(userRole)) {
            renderUserManagementView();
        } else {
            container.innerHTML = '<p class="access-denied">No tienes permiso para ver esta sección.</p>';
        }
    } catch (error) {
        container.innerHTML = `<p style="color:red;">${error.message}</p>`;
    }
}

function renderUserProfile(username) {
    const user = allUsersData.find(u => u.nombreUsuario === username);
    if (!user) return;

    const container = document.getElementById('user-content-container');
    container.innerHTML = `
        <form id="profile-form" onsubmit="handleProfileUpdate(event)">
            <div class="form-group">
                <label>Nombre Completo</label>
                <input type="text" value="${user.nombre}" disabled>
            </div>
            <div class="form-group">
                <label>Nombre de Usuario</label>
                <input type="text" value="${user.nombreUsuario}" disabled>
            </div>
            <div class="form-group">
                <label for="profile-telefono">Teléfono</label>
                <input type="tel" id="profile-telefono" value="${user.telefono || ''}">
            </div>
            <div class="form-group">
                <label for="profile-correo">Correo Electrónico</label>
                <input type="email" id="profile-correo" value="${user.correoElectronico || ''}">
            </div>
            <hr>
            <h4>Cambiar Contraseña</h4>
            <div class="form-group">
                <label for="profile-current-password">Contraseña Actual</label>
                <input type="password" id="profile-current-password">
            </div>
            <div class="form-group">
                <label for="profile-new-password">Nueva Contraseña (mínimo 8 caracteres)</label>
                <input type="password" id="profile-new-password" minlength="8">
            </div>
            <button type="submit" class="form-submit-btn">Guardar Cambios</button>
        </form>
    `;
}

function renderUserManagementView() {
    const container = document.getElementById('user-content-container');
    const filteredUsers = filterUsersByPrivilege(allUsersData, currentUser.privilegios);

    let tableHTML = `
        <button class="create-user-btn" onclick="openModal('user-form-modal', 'createUser')">
            <i class="fas fa-plus"></i> Crear Usuario
        </button>
        <div style="overflow-x:auto;">
        <table class="user-table">
            <thead>
                <tr>
                    <th>Nombre de Usuario</th>
                    <th>Nombre Completo</th>
                    <th>Rango</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                ${filteredUsers.map(user => `
                    <tr>
                        <td data-label="Usuario">${user.nombreUsuario}</td>
                        <td data-label="Nombre">${user.nombre}</td>
                        <td data-label="Rango">${user.privilegios}</td>
                        <td data-label="Acciones">
                            <button class="action-btn edit" onclick="openModal('user-form-modal', 'updateUser', '${user.nombreUsuario}')"><i class="fas fa-edit"></i></button>
                            <button class="action-btn delete" onclick="deleteUser('${user.nombreUsuario}')"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>
                `).join('')}
            </tbody>
        </table>
        </div>
    `;
    container.innerHTML = tableHTML;
}

function filterUsersByPrivilege(users, actorRole) {
    const roleHierarchy = { 'Desarrollador': 4, 'Gefe': 3, 'Supervisor': 2, 'Técnico': 1, 'Tecnico_Exterior': 0 };
    const actorLevel = roleHierarchy[actorRole] || -1;
    return users.filter(user => {
        const userLevel = roleHierarchy[user.privilegios] || -1;
        if (actorRole === 'Desarrollador') return true;
        if (user.privilegios === 'Tecnico_Exterior') return false;
        return actorLevel >= userLevel;
    });
}

function openModal(modalId, action, username = null) {
    const modal = document.getElementById(modalId);
    const form = modal.querySelector('form');
    form.reset();

    form.querySelector('#form-action').value = action;
    const passwordInput = form.querySelector('#password');

    if (action === 'createUser') {
        modal.querySelector('#modal-title').textContent = 'Crear Nuevo Usuario';
        form.querySelector('#original-username').value = '';
        form.querySelector('#nombre-usuario').disabled = false;
        passwordInput.required = true;
        passwordInput.placeholder = 'Mínimo 8 caracteres';
        populatePrivilegesDropdown(form.querySelector('#privilegios'), '');
    } else if (action === 'updateUser') {
        const user = allUsersData.find(u => u.nombreUsuario === username);
        if (!user) return;
        modal.querySelector('#modal-title').textContent = 'Editar Usuario';
        form.querySelector('#original-username').value = user.nombreUsuario;
        form.querySelector('#nombre').value = user.nombre;
        form.querySelector('#nombre-usuario').value = user.nombreUsuario;
        form.querySelector('#nombre-usuario').disabled = true; // No permitir cambiar username
        form.querySelector('#telefono').value = user.telefono || '';
        form.querySelector('#correo').value = user.correoElectronico || '';
        passwordInput.required = false;
        passwordInput.placeholder = 'Dejar en blanco para no cambiar';
        populatePrivilegesDropdown(form.querySelector('#privilegios'), user.privilegios);
    }

    modal.style.display = 'flex';
}

function populatePrivilegesDropdown(selectElement, selectedValue) {
    const actorRole = currentUser.privilegios;
    const roleHierarchy = { 'Desarrollador': 4, 'Gefe': 3, 'Supervisor': 2, 'Técnico': 1, 'Tecnico_Exterior': 0 };
    const actorLevel = roleHierarchy[actorRole] || -1;

    selectElement.innerHTML = '';

    Object.keys(roleHierarchy).forEach(role => {
        if ( (actorRole === 'Desarrollador') ||
             (role !== 'Tecnico_Exterior' && actorLevel >= roleHierarchy[role]) ) {
            const option = document.createElement('option');
            option.value = role;
            option.textContent = role.replace('_', ' ');
            if (role === selectedValue) {
                option.selected = true;
            }
            selectElement.appendChild(option);
        }
    });
}


function closeModal(modalId) {
    document.getElementById(modalId).style.display = 'none';
}

async function handleUserFormSubmit(event) {
    event.preventDefault();
    const form = event.target;
    const action = form.querySelector('#form-action').value;

    const data = {
        originalUsername: form.querySelector('#original-username').value,
        nombre: form.querySelector('#nombre').value,
        nombreUsuario: form.querySelector('#nombre-usuario').value,
        privilegios: form.querySelector('#privilegios').value,
        telefono: form.querySelector('#telefono').value,
        correo: form.querySelector('#correo').value,
        password: form.querySelector('#password').value
    };

    const payload = { action, actor: currentUser, data };

    try {
        const response = await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify(payload) });
        const result = await response.json();
        if (result.status === 'success') {
            showToast(result.message, 'success');
            closeModal('user-form-modal');
            loadInitialData(); // Recargar todo
        } else {
            throw new Error(result.message);
        }
    } catch (error) {
        showToast(`Error: ${error.message}`, 'error');
    }
}

async function handleProfileUpdate(event) {
    event.preventDefault();
    const data = {
        originalUsername: currentUser.nombreUsuario,
        telefono: document.getElementById('profile-telefono').value,
        correo: document.getElementById('profile-correo').value,
        password: document.getElementById('profile-new-password').value,
        currentPassword: document.getElementById('profile-current-password').value
    };

    if (data.password && !data.currentPassword) {
        showToast('Debes ingresar tu contraseña actual para establecer una nueva.', 'error');
        return;
    }

    const payload = { action: 'updateUser', actor: currentUser, data };

    try {
        const response = await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify(payload) });
        const result = await response.json();
        if (result.status === 'success') {
            showToast(result.message, 'success');
            // Limpiar campos de contraseña
            document.getElementById('profile-current-password').value = '';
            document.getElementById('profile-new-password').value = '';
        } else {
            throw new Error(result.message);
        }
    } catch (error) {
        showToast(`Error: ${error.message}`, 'error');
    }
}

async function deleteUser(username) {
    if (!confirm(`¿Estás seguro de que quieres eliminar al usuario ${username}? Esta acción no se puede deshacer.`)) return;

    const payload = { action: 'deleteUser', actor: currentUser, data: { username } };

    try {
        const response = await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify(payload) });
        const result = await response.json();
        if (result.status === 'success') {
            showToast(result.message, 'success');
            loadInitialData(); // Recargar
        } else {
            throw new Error(result.message);
        }
    } catch (error) {
        showToast(`Error: ${error.message}`, 'error');
    }
}

function showToast(message, type = 'info', duration = 3000) {
    const toast = document.getElementById('toast-notification');
    toast.textContent = message;
    toast.className = 'toast-notification';
    toast.classList.add(type, 'show');
    setTimeout(() => {
        toast.classList.remove('show');
    }, duration);
}
</script>

</body>
</html>
