<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agregar Registro - GPSpedia</title>
    <link rel="icon" href="https://drive.google.com/thumbnail?id=1NxBx-W_gWmcq3fA9zog6Dpe-WXpH_2e8&sz=2048">
    <style>
        /* Estilos Globales */
        html {
            height: 100%;
        }
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background: #f4f4f4;
            display: flex;
            flex-direction: column;
            min-height: 100%;
        }
        h1,h2,h3,h4 {
            margin: 10px 0;
        }
        .container {
            padding: 20px;
            max-width: 800px;
            margin: 0 auto;
            width: 100%;
            box-sizing: border-box;
            flex: 1 0 auto;
        }
        .backBtn {
            margin-bottom: 15px;
            cursor: pointer;
            color: #007bff;
            display: inline-flex;
            align-items: center;
            font-weight: bold;
            padding: 5px 10px;
            border-radius: 5px;
            transition: background 0.2s;
            text-decoration: none;
        }
        .backBtn:hover {
            background: #e9f7ff;
        }
        /* --- ESTILOS DEL ENCABEZADO (Header) --- */
        .header-container {
            display: flex;
            align-items: center;
            justify-content: flex-start;
            margin-bottom: 20px;
            padding: 0 20px;
        }
        .app-logo {
            max-width: 96px;
            height: auto;
            border-radius: 8px;
            margin-right: 15px;
        }
        h1.app-title {
            text-align: left;
            margin: 0;
            font-size: 2.2em;
            color: #333;
        }
        /* --- ESTILOS DEL FORMULARIO --- */
        .form-section {
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .form-section h3 {
            margin-top: 0;
            color: #007bff;
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .form-group input[type="text"],
        .form-group input[type="number"],
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
            font-size: 1em;
        }
         .form-group input:disabled, .form-group select:disabled, .form-group textarea:disabled {
            background-color: #e9ecef;
            opacity: 1;
        }
        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }
        .form-group input[type="file"] {
            padding: 3px;
        }
        .image-preview {
            margin-top: 10px;
            max-width: 150px;
            max-height: 150px;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 5px;
            display: none; /* Oculto hasta que se selecciona una imagen */
        }
        .submit-btn {
            background-color: #28a745;
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.1em;
            font-weight: bold;
            width: 100%;
            transition: background-color 0.3s;
        }
        .submit-btn:hover {
            background-color: #218838;
        }
        .hidden {
            display: none !important;
        }
        /* --- ESTILOS DE LA PANTALLA DE CARGA --- */
        #loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            color: white;
            flex-direction: column;
        }
        .spinner {
            border: 8px solid #f3f3f3;
            border-top: 8px solid #007bff;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* --- Footer --- */
        .footer {
            text-align: center;
            padding: 20px 0;
            margin-top: 40px;
            background-color: #333;
            color: #fff;
            font-size: 0.9em;
        }
        /* --- Modal --- */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 1001;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background: white;
            padding: 20px;
            border-radius: 8px;
            max-width: 90%;
            width: 500px;
            text-align: center;
        }
        .modal-content h3 {
             margin-top: 0;
             color: #007bff;
        }
        #existing-entry-info {
            text-align: left;
            margin-bottom: 20px;
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #eee;
            padding: 10px;
            border-radius: 5px;
        }
         #existing-entry-info p {
            margin: 5px 0;
        }
    </style>
</head>
<body>

    <div class="header-container">
        <div class="header-branding">
            <img src="https://drive.google.com/thumbnail?id=1NxBx-W_gWmcq3fA9zog6Dpe-WXpH_2e8&sz=2048" alt="Logo de GPSpedia" class="app-logo">
            <h1 class="app-title">GPSpedia</h1>
        </div>
        <div id="header-controls" style="display: flex; align-items: center; gap: 15px;">
            <span id="welcome-message" style="display: none; color: #333; font-weight: bold;"></span>
            <button id="logout-button" style="display: none; background-color: #dc3545; color: white; border: none; padding: 10px 15px; border-radius: 8px; cursor: pointer; font-weight: bold; transition: background-color 0.3s;">Cerrar Sesión</button>
        </div>
    </div>

    <div class="container">
        <a href="index.html" class="backBtn">← Volver al inicio</a>

        <h2>Formulario de Nuevo Registro</h2>

        <form id="corte-form">

            <div class="form-section">
                <h3>Información del Vehículo</h3>
                <div class="form-group">
                    <label for="categoria">Categoría del Vehículo</label>
                    <select id="categoria" name="categoria" required></select>
                </div>
                <div class="form-group">
                    <label for="marca">Marca</label>
                    <input type="text" id="marca" name="marca" required>
                </div>
                <div class="form-group">
                    <label for="modelo">Modelo</label>
                    <input type="text" id="modelo" name="modelo" required>
                </div>
                <div class="form-group">
                    <label for="anio">Año (Generación)</label>
                    <input type="text" id="anio" name="anio" placeholder="Ej: 2015-2020" required>
                </div>
                 <div class="form-group">
                    <label for="imagen_vehiculo">Imagen del Vehículo</label>
                    <input type="file" id="imagen_vehiculo" name="imagen_vehiculo" accept="image/*">
                    <img id="preview_imagen_vehiculo" class="image-preview" alt="Vista previa">
                </div>
            </div>

            <div class="form-section">
                <h3>Detalles de Cortes</h3>
                <div class="form-group">
                    <label for="tipo_encendido">Tipo de Encendido</label>
                    <select id="tipo_encendido" name="tipo_encendido" required></select>
                </div>

                <!-- Corte 1 -->
                <div id="corte1-section">
                    <h4>Corte 1</h4>
                    <div class="form-group">
                        <label for="tipo_corte1">Tipo de Corte 1</label>
                        <select id="tipo_corte1" name="tipo_corte1"></select>
                    </div>
                    <div class="form-group">
                        <label for="descripcion_corte1">Descripción del Corte 1</label>
                        <textarea id="descripcion_corte1" name="descripcion_corte1"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="imagen_corte1">Imagen del Corte 1</label>
                        <input type="file" id="imagen_corte1" name="imagen_corte1" accept="image/*">
                        <img id="preview_imagen_corte1" class="image-preview" alt="Vista previa">
                    </div>
                </div>

                <!-- Corte 2 -->
                <div id="corte2-section" class="hidden">
                    <h4>Corte 2</h4>
                    <div class="form-group">
                        <label for="tipo_corte2">Tipo de Corte 2</label>
                        <select id="tipo_corte2" name="tipo_corte2"></select>
                    </div>
                     <div class="form-group">
                        <label for="descripcion_corte2">Descripción del Corte 2</label>
                        <textarea id="descripcion_corte2" name="descripcion_corte2"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="imagen_corte2">Imagen del Corte 2</label>
                        <input type="file" id="imagen_corte2" name="imagen_corte2" accept="image/*">
                        <img id="preview_imagen_corte2" class="image-preview" alt="Vista previa">
                    </div>
                </div>

                <!-- Corte 3 -->
                <div id="corte3-section" class="hidden">
                    <h4>Corte 3</h4>
                    <div class="form-group">
                        <label for="tipo_corte3">Tipo de Corte 3</label>
                        <select id="tipo_corte3" name="tipo_corte3"></select>
                    </div>
                     <div class="form-group">
                        <label for="descripcion_corte3">Descripción del Corte 3</label>
                        <textarea id="descripcion_corte3" name="descripcion_corte3"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="imagen_corte3">Imagen del Corte 3</label>
                        <input type="file" id="imagen_corte3" name="imagen_corte3" accept="image/*">
                        <img id="preview_imagen_corte3" class="image-preview" alt="Vista previa">
                    </div>
                </div>
            </div>

            <div class="form-section">
                <h3>Información Adicional</h3>
                <div class="form-group">
                    <label for="apertura">Apertura</label>
                    <textarea id="apertura" name="apertura"></textarea>
                </div>
                 <div class="form-group">
                    <label for="imagen_apertura">Imagen de la Apertura</label>
                    <input type="file" id="imagen_apertura" name="imagen_apertura" accept="image/*">
                    <img id="preview_imagen_apertura" class="image-preview" alt="Vista previa">
                </div>
                <div class="form-group">
                    <label for="cables_alimentacion">Cables de Alimentación</label>
                    <textarea id="cables_alimentacion" name="cables_alimentacion"></textarea>
                </div>
                <div class="form-group">
                    <label for="imagen_alimentacion">Imagen de Cables de Alimentación</label>
                    <input type="file" id="imagen_alimentacion" name="imagen_alimentacion" accept="image/*">
                    <img id="preview_imagen_alimentacion" class="image-preview" alt="Vista previa">
                </div>
            </div>

            <div class="form-section">
                <h3>Finalización</h3>
                <div class="form-group">
                    <label for="notas">Notas Adicionales</label>
                    <textarea id="notas" name="notas"></textarea>
                </div>
            </div>

            <button type="submit" class="submit-btn">Guardar Registro</button>
        </form>

    </div>

    <footer class="footer">
        Gpspedia 2025© todos los derechos reservados.
    </footer>

    <div id="loading-overlay" class="hidden">
        <div class="spinner"></div>
        <p>Procesando...</p>
    </div>

    <!-- Modal for existing entry -->
    <div id="existing-entry-modal" class="modal hidden">
        <div class="modal-content">
            <h3>Vehículo Encontrado</h3>
            <div id="existing-entry-info"></div>
            <p>¿La información que deseas agregar corresponde a este vehículo?</p>
            <button id="confirm-existing-btn" class="submit-btn" style="background: #28a745; margin-bottom:10px;">Sí, deseo agregar nueva información</button>
            <button id="cancel-existing-btn" class="submit-btn" style="background: #dc3545;">No, cancelar</button>
        </div>
    </div>

    <div id="login-modal" style="display: none;">
        <!-- Este div es necesario para que auth.js funcione, aunque no se use directamente aquí -->
        <p id="login-error"></p>
        <input id="username">
        <input id="password">
    </div>

    <script src="auth.js"></script>
    <script>
        const API_KEY = "AIzaSyCooAsC52X4ccENCT6p3qh_82ErBxP47Lg";
        const SPREADSHEET_ID = "1jEdC2NMc2a5F36xE2MJfgxMZiZFVfeDqnCdVizNGIMo";
        const SPREADSHEET_NAME = "Cortes";

        // ===================================================================================
        // !!! ACCIÓN REQUERIDA !!!
        // 1. Ve a tu proyecto de Google Apps Script (`Code.gs`).
        // 2. Haz clic en "Implementar" -> "Nueva implementación".
        // 3. Selecciona "Aplicación web" como tipo de implementación.
        // 4. Asegúrate de que "Ejecutar como" esté configurado como "Yo" y "Quién tiene acceso" como "Cualquier persona".
        // 5. Haz clic en "Implementar" y copia la "URL de la aplicación web".
        // 6. Pega esa URL aquí abajo, reemplazando 'URL_DE_TU_WEB_APP_AQUI'.
        // ===================================================================================
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbx15SA7DHRD3j3RIHxOcdJEKYGnFIEjzamyJ4j6zND_I6HR-30ClLpD2BWoOhg-7tpG/exec';

        const form = document.getElementById('corte-form');
        const loadingOverlay = document.getElementById('loading-overlay');
        const modal = document.getElementById('existing-entry-modal');
        let existingRowData = null;

        // --- INICIALIZACIÓN ---
        // La inicialización de la autenticación se maneja en auth.js.
        // Aquí solo configuramos lo específico de esta página.
        document.addEventListener('DOMContentLoaded', () => {
            setupImagePreviews();
            setupFormListeners();
        });

        // Esta función será llamada por auth.js después de un inicio de sesión exitoso.
        function onLoginSuccess() {
            // Cargar los datos de los desplegables solo después de que el usuario haya iniciado sesión.
            loadDropdownData();
        }

        // --- CARGA DE DATOS PARA DROPDOWNS ---
        async function loadDropdownData() {
            const ranges = [
                'Cortes!B2:B', // Categoria
                'Cortes!F2:F', // Tipo de encendido
                'Cortes!H2:H', // Tipo de corte 1
                'Cortes!L2:L', // Tipo de corte 2
                'Cortes!U2:U'  // Tipo de corte 3
            ];
            const url = `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values:batchGet?ranges=${ranges.join('&ranges=')}&key=${API_KEY}`;

            try {
                const response = await fetch(url);
                const data = await response.json();

                const [categorias, encendidos, cortes1, cortes2, cortes3] = data.valueRanges.map(range =>
                    [...new Set(range.values?.flat().filter(Boolean) || [])]
                );

                const allCortes = [...new Set([...cortes1, ...cortes2, ...cortes3])];

                populateSelect('categoria', categorias);
                populateSelect('tipo_encendido', encendidos);
                populateSelect('tipo_corte1', allCortes, true);
                populateSelect('tipo_corte2', allCortes, true);
                populateSelect('tipo_corte3', allCortes, true);

            } catch (error) {
                console.error('Error cargando datos para los desplegables:', error);
                alert('No se pudieron cargar las opciones del formulario. Inténtalo de nuevo.');
            }
        }

        function populateSelect(elementId, options, includeEmpty = false) {
            const select = document.getElementById(elementId);
            select.innerHTML = ''; // Limpiar opciones
            if (includeEmpty) {
                const defaultOption = document.createElement('option');
                defaultOption.value = '';
                defaultOption.textContent = 'Seleccionar...';
                select.appendChild(defaultOption);
            }
            options.forEach(option => {
                const opt = document.createElement('option');
                opt.value = option;
                opt.textContent = option;
                select.appendChild(opt);
            });
        }

        // --- VISTAS PREVIAS DE IMÁGENES ---
        function setupImagePreviews() {
            document.querySelectorAll('input[type="file"]').forEach(input => {
                input.addEventListener('change', event => {
                    const file = event.target.files[0];
                    if (file) {
                        const preview = document.getElementById(`preview_${input.id}`);
                        const reader = new FileReader();
                        reader.onload = e => {
                            preview.src = e.target.result;
                            preview.style.display = 'block';
                        };
                        reader.readAsDataURL(file);
                    }
                });
            });
        }

        // --- LÓGICA DEL FORMULARIO ---
        function setupFormListeners() {
            // Listener para buscar vehículo existente
            ['marca', 'modelo', 'anio'].forEach(id => {
                document.getElementById(id).addEventListener('blur', checkExistingVehicle);
            });

            // Listener para envío del formulario
            form.addEventListener('submit', handleFormSubmit);

            // Listeners del modal
            document.getElementById('confirm-existing-btn').addEventListener('click', () => {
                modal.classList.add('hidden');
                adaptFormForUpdate();
            });
            document.getElementById('cancel-existing-btn').addEventListener('click', () => {
                window.location.reload(); // Recargar para limpiar todo
            });
        }

        // --- BÚSQUEDA DE VEHÍCULO EXISTENTE ---
        async function checkExistingVehicle() {
            const marca = document.getElementById('marca').value.trim();
            const modelo = document.getElementById('modelo').value.trim();
            const anio = document.getElementById('anio').value.trim();

            if (marca && modelo && anio) {
                loadingOverlay.classList.remove('hidden');
                const query = encodeURIComponent(`SELECT * WHERE D = '${marca}' AND E = '${modelo}' AND G = '${anio}'`);
                const url = `https://docs.google.com/spreadsheets/d/${SPREADSHEET_ID}/gviz/tq?tqx=out:json&sheet=${SPREADSHEET_NAME}&tq=${query}`;

                try {
                    const response = await fetch(url);
                    const text = await response.text();
                    const data = JSON.parse(text.substring(47).slice(0, -2));

                    if (data.table.rows.length > 0) {
                        existingRowData = data.table.rows[0].c;
                        displayExistingData(existingRowData);
                        modal.classList.remove('hidden');
                    }
                } catch (error) {
                    console.error("Error en la búsqueda:", error);
                } finally {
                    loadingOverlay.classList.add('hidden');
                }
            }
        }

        function displayExistingData(rowData) {
            const infoDiv = document.getElementById('existing-entry-info');
            const getValue = index => (rowData[index] ? rowData[index].v : 'N/A');
            infoDiv.innerHTML = `
                <p><strong>Categoría:</strong> ${getValue(1)}</p>
                <p><strong>Encendido:</strong> ${getValue(5)}</p>
                <p><strong>Corte 1:</strong> ${getValue(7)} (${getValue(8)})</p>
                <p><strong>Corte 2:</strong> ${getValue(11)} (${getValue(10)})</p>
                <p><strong>Corte 3:</strong> ${getValue(20)} (${getValue(21)})</p>
                <p><strong>Apertura:</strong> ${getValue(13)}</p>
                <p><strong>Alimentación:</strong> ${getValue(16)}</p>
            `;
        }

        function adaptFormForUpdate() {
            const fields = {
                categoria: 1, tipo_encendido: 5,
                tipo_corte1: 7, descripcion_corte1: 8,
                tipo_corte2: 11, descripcion_corte2: 10,
                tipo_corte3: 20, descripcion_corte3: 21,
                apertura: 13, cables_alimentacion: 16, notas: 15
            };

            // Llenar y deshabilitar campos con datos existentes
            Object.entries(fields).forEach(([id, index]) => {
                const element = document.getElementById(id);
                const value = existingRowData[index]?.v;
                if (value) {
                    element.value = value;
                    element.disabled = true;
                    // También deshabilitar input de imagen si la descripción existe
                    if(id.startsWith('descripcion')) {
                        document.getElementById(id.replace('descripcion', 'imagen')).disabled = true;
                    }
                }
            });

            // Mostrar secciones de corte si están vacías
            if (!existingRowData[7]?.v) { // Si no hay corte 1
                 // No hacer nada, el usuario llena corte 1
            } else if (!existingRowData[11]?.v) { // Si hay corte 1 pero no corte 2
                document.getElementById('corte2-section').classList.remove('hidden');
            } else if (!existingRowData[20]?.v) { // Si hay corte 1 y 2 pero no 3
                document.getElementById('corte2-section').classList.remove('hidden');
                document.getElementById('corte3-section').classList.remove('hidden');
            }
        }

        // --- ENVÍO DEL FORMULARIO ---
        async function handleFormSubmit(event) {
            event.preventDefault();
            loadingOverlay.classList.remove('hidden');

            const formData = new FormData(form);
            const data = {};
            formData.forEach((value, key) => { data[key] = value });

            // Añadir el nombre del colaborador automáticamente desde la sesión
            if (currentUser && currentUser.Nombre) {
                data.colaborador = currentUser.Nombre;
            } else {
                alert("Error: No se pudo identificar al usuario. Por favor, inicia sesión de nuevo.");
                loadingOverlay.classList.add('hidden');
                return;
            }

            try {
                // Convertir archivos a Base64
                const fileInputs = form.querySelectorAll('input[type="file"]');
                for (const input of fileInputs) {
                    if (input.files[0]) {
                        const file = input.files[0];
                        const base64String = await toBase64(file);
                        data[input.name + 'Base64'] = base64String;
                        data[input.name + 'MimeType'] = file.type;
                        data[input.name + 'FileName'] = file.name;
                    }
                }

                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                if (result.status === 'success') {
                    alert('¡Registro guardado con éxito!');
                    form.reset();
                    document.querySelectorAll('.image-preview').forEach(p => p.style.display = 'none');
                    window.location.href = 'index.html';
                } else {
                    throw new Error(result.message);
                }

            } catch (error) {
                console.error('Error al enviar el formulario:', error);
                alert(`Error: ${error.message}`);
            } finally {
                loadingOverlay.classList.add('hidden');
            }
        }

        const toBase64 = file => new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = () => resolve(reader.result.split(',')[1]);
            reader.onerror = error => reject(error);
        });

    </script>

</body>
</html>
